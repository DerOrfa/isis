<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ISIS Core Library: /SCR/isis/lib/ImageIO/imageFormat_Nifti_SA.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ISIS Core Library&#160;<span id="projectnumber">(r115-gcf9c9cc)</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/SCR/isis/lib/ImageIO/imageFormat_Nifti_SA.cpp</h1>  </div>
</div>
<div class="contents">
<a href="imageFormat__Nifti__SA_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;DataStorage/io_interface.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;DataStorage/fileptr.hpp&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;CoreUtils/matrix.hpp&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;boost/date_time/gregorian/gregorian.hpp&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;boost/type_traits/make_signed.hpp&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a1ef0dc17948c65b6a7311fe96ddfc441">00008</a> <span class="preprocessor">#define NIFTI_TYPE_UINT8           2</span>
<a name="l00009"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a253e4b750f2aa75a3efdac232663b85c">00009</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_UINT16        512</span>
<a name="l00010"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a75125d71779526934b59d4d402b5fe10">00010</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_UINT32        768</span>
<a name="l00011"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#ab8a45494d65119cdd94df359ee18b94b">00011</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_UINT64       1280</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span>
<a name="l00013"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a7ed8fda7096e3ff6d4051cd73d708688">00013</a> <span class="preprocessor">#define NIFTI_TYPE_INT8          256</span>
<a name="l00014"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a746b4eba0eaaac6366b232b46f590f48">00014</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_INT16           4</span>
<a name="l00015"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a9bf4e01d93f73a1eaf8966f387e65999">00015</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_INT32           8</span>
<a name="l00016"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a68fa86838cb29705b5a8ffc9ac158419">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_INT64        1024</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a8220ccec425b9387abf3d2b71ac0be7e">00018</a> <span class="preprocessor">#define NIFTI_TYPE_FLOAT32        16</span>
<a name="l00019"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a1253a2540a68b4dd7a5d78bc8c4c2a4d">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_FLOAT64        64</span>
<a name="l00020"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a33274f22307e976a90c24917467e6c56">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_FLOAT128     1536</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00022"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a9ae010c2ff48380fcb611c06048956c5">00022</a> <span class="preprocessor">#define NIFTI_TYPE_COMPLEX64      32</span>
<a name="l00023"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a65e61452b861209be2eb1a5a96556ca9">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_COMPLEX128   1792</span>
<a name="l00024"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a08c3af37cce4c1dd34703d1fbbdf9129">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_TYPE_COMPLEX256   2048</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#abad329a29f5f3b65c1e4de114d7bb06b">00026</a> <span class="preprocessor">#define NIFTI_TYPE_RGB24         128</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#ad1f3084d4febc60e2d64d85d72907e8a">00028</a> <span class="preprocessor">#define NIFTI_SLICE_SEQ_INC  1</span>
<a name="l00029"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a4de04fa4c62c518259ea4b22c23661e8">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_SLICE_SEQ_DEC  2</span>
<a name="l00030"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a27dfca46abf4fa1c0c66b9612f34c790">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_SLICE_ALT_INC  3</span>
<a name="l00031"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a142ac8b09c85f608a96e01e795be1e62">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_SLICE_ALT_DEC  4</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#aab4358e3a869324c9bbd4b2d4eb5567a">00034</a> <span class="preprocessor">#define NIFTI_UNITS_UNKNOWN 0</span>
<a name="l00035"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a58b8564584f3e2cda3bfb9daebdd28d5">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_METER   1</span>
<a name="l00036"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#ae37d3c19fa7561f6ef662bc27a4af5d4">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_MM      2</span>
<a name="l00037"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a9ab584aac820e59dc2373581ee2c237e">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_MICRON  3</span>
<a name="l00038"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#ae1126a70acd21a99d7748c7ee9f877a8">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_SEC     8</span>
<a name="l00039"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a3a890f2c798b2aa7853135e4c9b03113">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_MSEC   16</span>
<a name="l00040"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a17714a9f67cbf27371ee9dda4a046942">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_USEC   24</span>
<a name="l00041"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a3f82832f715abf1f8afeebe900bd2f19">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_HZ     32</span>
<a name="l00042"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a56bb7231fda9e33cbe20df645c6c0f13">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_PPM    40</span>
<a name="l00043"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#a23156c7a00356dd9896d509a0b9a5c93">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define NIFTI_UNITS_RADS   48</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>                               
<a name="l00045"></a>00045 <span class="keyword">namespace </span>isis
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047 <span class="keyword">namespace </span>image_io
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">namespace </span>_internal{
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">//define the nifti-header (brazenly stolen from nifti1.h)</span>
<a name="l00053"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">00053</a> <span class="keyword">struct </span><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">nifti_1_header</a> {
<a name="l00054"></a>00054                          <span class="comment">/* NIFTI-1 usage         */</span>    <span class="comment">/* ANALYZE 7.5 field(s) */</span>
<a name="l00055"></a>00055                                                         <span class="comment">/*--- was header_key substruct ---*/</span>
<a name="l00056"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">00056</a>     <span class="keywordtype">int</span>   <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a>;      <span class="comment">/* int sizeof_hdr;      */</span>
<a name="l00057"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a791ee440961f2960b1667471f4e623bf">00057</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a791ee440961f2960b1667471f4e623bf">data_type</a>[10];   <span class="comment">/* char data_type[10];  */</span>
<a name="l00058"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0369b3d05d6a737f64cce1289411a12e">00058</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0369b3d05d6a737f64cce1289411a12e">db_name</a>[18];     <span class="comment">/* char db_name[18];    */</span>
<a name="l00059"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a90a45f4754ba3d8640835eb8379fd225">00059</a>     <span class="keywordtype">int</span>   <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a90a45f4754ba3d8640835eb8379fd225">extents</a>;         <span class="comment">/* int extents;         */</span>
<a name="l00060"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a7e45844737abeccbbcd88a661a716936">00060</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a7e45844737abeccbbcd88a661a716936">session_error</a>;   <span class="comment">/* short session_error; */</span>
<a name="l00061"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a949691019f57ed40cb512be6154d8a10">00061</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a949691019f57ed40cb512be6154d8a10">regular</a>;         <span class="comment">/* char regular;        */</span>
<a name="l00062"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adb700b62f9c13d0ef11401b1da6f9931">00062</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adb700b62f9c13d0ef11401b1da6f9931">dim_info</a>;        <span class="comment">/* char hkey_un0;       */</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064                                         <span class="comment">/*--- was image_dimension substruct ---*/</span>
<a name="l00065"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">00065</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[8];          <span class="comment">/* short dim[8];        */</span>
<a name="l00066"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adeb6c079ba9e4687e3099af19850ee9f">00066</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adeb6c079ba9e4687e3099af19850ee9f">intent_p1</a> ;      <span class="comment">/* short unused8;       */</span>
<a name="l00067"></a>00067                                                         <span class="comment">/* short unused9;       */</span>
<a name="l00068"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b8100de819afb3e0ec28e7b2b987622">00068</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b8100de819afb3e0ec28e7b2b987622">intent_p2</a> ;      <span class="comment">/* short unused10;      */</span>
<a name="l00069"></a>00069                                                         <span class="comment">/* short unused11;      */</span>
<a name="l00070"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aef7df04bb20707637d5826898b6766bd">00070</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aef7df04bb20707637d5826898b6766bd">intent_p3</a> ;      <span class="comment">/* short unused12;      */</span>
<a name="l00071"></a>00071                                                         <span class="comment">/* short unused13;      */</span>
<a name="l00072"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">00072</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">intent_code</a> ;    <span class="comment">/* short unused14;      */</span>
<a name="l00073"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">00073</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a>;        <span class="comment">/* short datatype;      */</span>
<a name="l00074"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">00074</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a>;          <span class="comment">/* short bitpix;        */</span>
<a name="l00075"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a792a1bb6fc1eba891ecdcc696a6c6dd9">00075</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a792a1bb6fc1eba891ecdcc696a6c6dd9">slice_start</a>;     <span class="comment">/* short dim_un0;       */</span>
<a name="l00076"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">00076</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[8];       <span class="comment">/* float pixdim[8];     */</span>
<a name="l00077"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">00077</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>;      <span class="comment">/* float vox_offset;    */</span>
<a name="l00078"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">00078</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">scl_slope</a> ;      <span class="comment">/* float funused1;      */</span>
<a name="l00079"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a570f6c8dc72f63af277406d0a84ca604">00079</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a570f6c8dc72f63af277406d0a84ca604">scl_inter</a> ;      <span class="comment">/* float funused2;      */</span>
<a name="l00080"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa94982ee96bb81abd1d9165aedc6d75a">00080</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa94982ee96bb81abd1d9165aedc6d75a">slice_end</a>;       <span class="comment">/* float funused3;      */</span>
<a name="l00081"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">00081</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a> ;   
<a name="l00082"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">00082</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> ;   
<a name="l00083"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">00083</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">cal_max</a>;         <span class="comment">/* float cal_max;       */</span>
<a name="l00084"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">00084</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">cal_min</a>;         <span class="comment">/* float cal_min;       */</span>
<a name="l00085"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">00085</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>;  <span class="comment">/* float compressed;    */</span>
<a name="l00086"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a6146d9ec1f864ccbf221e4cc9976baf0">00086</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a6146d9ec1f864ccbf221e4cc9976baf0">toffset</a>;         <span class="comment">/* float verified;      */</span>
<a name="l00087"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a08826cdf9961a168358836a0a39c9e4e">00087</a>     <span class="keywordtype">int</span>   <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a08826cdf9961a168358836a0a39c9e4e">glmax</a>;           <span class="comment">/* int glmax;           */</span>
<a name="l00088"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ae9c0b2b09667ec96512db03acb1956af">00088</a>     <span class="keywordtype">int</span>   <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ae9c0b2b09667ec96512db03acb1956af">glmin</a>;           <span class="comment">/* int glmin;           */</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090                                             <span class="comment">/*--- was data_history substruct ---*/</span>
<a name="l00091"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">00091</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a>[80];     <span class="comment">/* char descrip[80];    */</span>
<a name="l00092"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a7d23d26ce3ae279858c3f2005d6e1de8">00092</a>     <span class="keywordtype">char</span>  <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a7d23d26ce3ae279858c3f2005d6e1de8">aux_file</a>[24];    <span class="comment">/* char aux_file[24];   */</span>
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">00094</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> ;     <span class="comment">/*-- all ANALYZE 7.5 ---*/</span>
<a name="l00095"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">00095</a>     <span class="keywordtype">short</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> ;     <span class="comment">/*   fields below here  */</span>
<a name="l00096"></a>00096                                                         <span class="comment">/*   are replaced       */</span>
<a name="l00097"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">00097</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">quatern_b</a> ;    
<a name="l00098"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">00098</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">quatern_c</a> ;    
<a name="l00099"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">00099</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">quatern_d</a> ;    
<a name="l00100"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">00100</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">qoffset_x</a> ;    
<a name="l00101"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">00101</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">qoffset_y</a> ;    
<a name="l00102"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">00102</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">qoffset_z</a> ;    
<a name="l00104"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">00104</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>[4] ;    
<a name="l00105"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">00105</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>[4] ;    
<a name="l00106"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">00106</a>     <span class="keywordtype">float</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>[4] ;    
<a name="l00108"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a79917d1fc317b54055fce53653c14d89">00108</a>     <span class="keywordtype">char</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a79917d1fc317b54055fce53653c14d89">intent_name</a>[16];
<a name="l00110"></a><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa359be1793179515940ddbd366030c18">00110</a>     <span class="keywordtype">char</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa359be1793179515940ddbd366030c18">magic</a>[4] ;      
<a name="l00112"></a>00112 } ;                   <span class="comment">/**** 348 bytes total ****/</span>
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115     
<a name="l00116"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html">00116</a> <span class="keyword">class </span><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html">ImageFormat_NiftiSa</a>: <span class="keyword">public</span> <a class="code" href="io__interface_8h.html#ad534fde7b54f25d7d340da0fbc40753f">FileFormat</a>
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;short&gt;</a> nifti2isis;
<a name="l00119"></a>00119 <span class="keyword">public</span>:
<a name="l00120"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#abac02a5a0a75279ddefba6231e0aa9de">00120</a>     <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#abac02a5a0a75279ddefba6231e0aa9de">ImageFormat_NiftiSa</a>(){
<a name="l00121"></a>00121         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a7ed8fda7096e3ff6d4051cd73d708688">NIFTI_TYPE_INT8</a> ]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt; int8_t&gt;::staticID</a>;
<a name="l00122"></a>00122         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a746b4eba0eaaac6366b232b46f590f48">NIFTI_TYPE_INT16</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int16_t&gt;::staticID</a>;
<a name="l00123"></a>00123         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a9bf4e01d93f73a1eaf8966f387e65999">NIFTI_TYPE_INT32</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int32_t&gt;::staticID</a>;
<a name="l00124"></a>00124         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a68fa86838cb29705b5a8ffc9ac158419">NIFTI_TYPE_INT64</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int64_t&gt;::staticID</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a1ef0dc17948c65b6a7311fe96ddfc441">NIFTI_TYPE_UINT8</a> ]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt; uint8_t&gt;::staticID</a>;
<a name="l00127"></a>00127         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a253e4b750f2aa75a3efdac232663b85c">NIFTI_TYPE_UINT16</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint16_t&gt;::staticID</a>;
<a name="l00128"></a>00128         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a75125d71779526934b59d4d402b5fe10">NIFTI_TYPE_UINT32</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint32_t&gt;::staticID</a>;
<a name="l00129"></a>00129         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#ab8a45494d65119cdd94df359ee18b94b">NIFTI_TYPE_UINT64</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint64_t&gt;::staticID</a>;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a8220ccec425b9387abf3d2b71ac0be7e">NIFTI_TYPE_FLOAT32</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;float&gt;::staticID</a>;
<a name="l00132"></a>00132         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a1253a2540a68b4dd7a5d78bc8c4c2a4d">NIFTI_TYPE_FLOAT64</a>]=<a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;double&gt;::staticID</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         <span class="keyword">typedef</span> std::map&lt;short,unsigned short&gt;::const_reference ref_type;
<a name="l00135"></a>00135         BOOST_FOREACH(ref_type ref, <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>){
<a name="l00136"></a>00136             <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2fe1ad4a0e93a12d8484915e43107789">isis_type2nifti_type</a>[ref.second]=ref.first;
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="comment">/*      nii2isis[NIFTI_TYPE_COMPLEX64 ]=data::ValuePtr&lt;std::complex&lt; float &gt; &gt;::staticID;</span>
<a name="l00140"></a>00140 <span class="comment">        nii2isis[NIFTI_TYPE_COMPLEX128]=data::ValuePtr&lt;std::complex&lt; double &gt; &gt;::staticID;*/</span>
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142 <span class="keyword">protected</span>:
<a name="l00143"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a43b19f30417bc0989d6d7d185eeb89b4">00143</a>     std::string <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a43b19f30417bc0989d6d7d185eeb89b4">suffixes</a>()<span class="keyword">const </span>{
<a name="l00144"></a>00144         <span class="keywordflow">return</span> std::string( <span class="stringliteral">&quot;.nii&quot;</span> );
<a name="l00145"></a>00145     }
<a name="l00146"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">00146</a>     std::map&lt;short,unsigned short&gt; <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>;
<a name="l00147"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2fe1ad4a0e93a12d8484915e43107789">00147</a>     std::map&lt;unsigned short,short&gt; <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2fe1ad4a0e93a12d8484915e43107789">isis_type2nifti_type</a>;
<a name="l00148"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a10e7556128ac645162ef5902a0064ae3">00148</a>     <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a10e7556128ac645162ef5902a0064ae3">typeFallBack</a>(){
<a name="l00149"></a>00149         <span class="keyword">typedef</span> <span class="keyword">typename</span> boost::make_signed&lt;T&gt;::type NEW_T;
<a name="l00150"></a>00150         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;T&gt;::staticName</a>() &lt;&lt;  <span class="stringliteral">&quot; is not supported by fsl falling back to &quot;</span> &lt;&lt; <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;NEW_T&gt;::staticName</a>();
<a name="l00151"></a>00151         <span class="keywordflow">return</span> <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;NEW_T&gt;::staticID</a>;
<a name="l00152"></a>00152     }
<a name="l00153"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2061cef33b0436a0e979a7e243e17367">00153</a>     <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2061cef33b0436a0e979a7e243e17367">guessSliceOrdering</a>(<span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> img,<span class="keywordtype">char</span> &amp;slice_code, <span class="keywordtype">float</span> &amp;slice_duration){
<a name="l00154"></a>00154         <span class="keyword">const</span> std::list&lt; util::PropertyValue &gt; dummy=img.<a class="code" href="classisis_1_1data_1_1Image.html#a97524a597e61074c8b4b2e6e0ebdf8e6" title="Get a list of the properties of the chunks for the given key.">getChunksProperties</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>);
<a name="l00155"></a>00155         <span class="keyword">const</span> std::vector&lt; util::PropertyValue &gt; acnums(dummy.begin(),dummy.end());
<a name="l00156"></a>00156         <span class="keywordflow">if</span>(acnums.size()&lt;=1){ <span class="comment">// seems like there is only one chunk - slice doesnt matter - just choose NIFTI_SLICE_SEQ_INC</span>
<a name="l00157"></a>00157             slice_code=<a class="code" href="imageFormat__Nifti__SA_8cpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>;
<a name="l00158"></a>00158         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(acnums[0]-&gt;isEmpty()){
<a name="l00159"></a>00159             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a>) &lt;&lt; <span class="stringliteral">&quot;There is no acquisitionNumber for the first chunk, assuming normal slice ordering.&quot;</span>;
<a name="l00160"></a>00160             slice_code=<a class="code" href="imageFormat__Nifti__SA_8cpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>;
<a name="l00161"></a>00161         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>()
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="keywordflow">if</span>(acnums.size()&gt;2){ <span class="comment">// might be interleaved</span>
<a name="l00164"></a>00164             
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166     }
<a name="l00167"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a399ad6a6ec1d8dcfa3581a49e721064e">00167</a>     <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a399ad6a6ec1d8dcfa3581a49e721064e">parseDescripForSPM</a>(<a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">util::PropertyMap</a> &amp;props, <span class="keyword">const</span> <span class="keywordtype">char</span> desc[]){
<a name="l00168"></a>00168         <span class="comment">//check description for tr, te and fa and date which is written by spm8</span>
<a name="l00169"></a>00169         boost::regex descriptionRegex(
<a name="l00170"></a>00170             <span class="stringliteral">&quot;.*TR=([[:digit:]]{1,})ms.*TE=([[:digit:]]{1,})ms.*FA=([[:digit:]]{1,})deg\\ *([[:digit:]]{1,2}).([[:word:]]{3}).([[:digit:]]{4})\\ *([[:digit:]]{1,2}):([[:digit:]]{1,2}):([[:digit:]]{1,2}).*&quot;</span>
<a name="l00171"></a>00171         );
<a name="l00172"></a>00172         boost::cmatch results;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="keywordflow">if</span> ( boost::regex_match( desc, results,  descriptionRegex ) ) {
<a name="l00175"></a>00175             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;repetitionTime&quot;</span>)=<a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint16_t&gt;</a>( results.str( 1 ) );
<a name="l00176"></a>00176             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;echoTime&quot;</span>)=<a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint16_t&gt;</a>( results.str( 2 ) );
<a name="l00177"></a>00177             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;flipAngle&quot;</span>)=<a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint16_t&gt;</a>( results.str( 2 ) );
<a name="l00178"></a>00178 
<a name="l00179"></a>00179             <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;int&gt;</a> day=results.str( 4 ), month=results.str( 5 ), year=results.str( 6 );
<a name="l00180"></a>00180             <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint8_t&gt;</a> hours=boost::lexical_cast&lt;uint8_t&gt;( results.str( 7 ) ), minutes=boost::lexical_cast&lt;uint8_t&gt;( results.str( 8 ) ), seconds=boost::lexical_cast&lt;uint8_t&gt;( results.str( 9 ) );
<a name="l00181"></a>00181 
<a name="l00182"></a>00182             boost::posix_time::ptime sequenceStart=boost::posix_time::ptime(
<a name="l00183"></a>00183                 boost::gregorian::date((<span class="keywordtype">int</span>)year,(<span class="keywordtype">int</span>)month,(<span class="keywordtype">int</span>)day),
<a name="l00184"></a>00184                 boost::posix_time::time_duration( hours, minutes, seconds )
<a name="l00185"></a>00185             );
<a name="l00186"></a>00186             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;boost::posix_time::ptime&gt;( <span class="stringliteral">&quot;sequenceStart&quot;</span>, sequenceStart );
<a name="l00187"></a>00187 
<a name="l00188"></a>00188             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( ImageIoLog, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00189"></a>00189                 &lt;&lt; <span class="stringliteral">&quot;Using Tr=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;repetitionTime&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;, Te=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;echoTime&quot;</span>) 
<a name="l00190"></a>00190                 &lt;&lt; <span class="stringliteral">&quot;, flipAngle=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;flipAngle&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; and sequenceStart=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;sequenceStart&quot;</span>)
<a name="l00191"></a>00191                 &lt;&lt; <span class="stringliteral">&quot; from SPM8 description.&quot;</span>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00194"></a>00194         } <span class="keywordflow">else</span>
<a name="l00195"></a>00195             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00196"></a>00196     }
<a name="l00197"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a0d427df1136e06823def3406a81d8562">00197</a>     <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a0d427df1136e06823def3406a81d8562">storeHeader</a>(<span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">util::PropertyMap</a> &amp;props,<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *head){
<a name="l00198"></a>00198         <span class="comment">// implicit stuff</span>
<a name="l00199"></a>00199         head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">intent_code</a>=0;
<a name="l00200"></a>00200         head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a792a1bb6fc1eba891ecdcc696a6c6dd9">slice_start</a>=0;
<a name="l00201"></a>00201         head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa94982ee96bb81abd1d9165aedc6d75a">slice_end</a>=head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3];
<a name="l00202"></a>00202 
<a name="l00203"></a>00203         <span class="comment">//in isis length is allways mm and time duration is allways msecs</span>
<a name="l00204"></a>00204         head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a>=<a class="code" href="imageFormat__Nifti__SA_8cpp.html#ae37d3c19fa7561f6ef662bc27a4af5d4">NIFTI_UNITS_MM</a>|<a class="code" href="imageFormat__Nifti__SA_8cpp.html#a3a890f2c798b2aa7853135e4c9b03113">NIFTI_UNITS_MSEC</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="comment">//store description if there is one</span>
<a name="l00207"></a>00207         <span class="keywordflow">if</span>(props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;sequenceDescription&quot;</span>))
<a name="l00208"></a>00208             strncpy(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a>,props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;std::string&gt;(<span class="stringliteral">&quot;sequenceDescription&quot;</span>).c_str(),80);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// store niftis original sform if its there</span>
<a name="l00211"></a>00211         <span class="keywordflow">if</span>(props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/sform_code&quot;</span>)){
<a name="l00212"></a>00212             head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a>=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">short</span>&gt;(<span class="stringliteral">&quot;nifti/sform_code&quot;</span>);
<a name="l00213"></a>00213             <span class="keywordflow">if</span>(props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/srow_x&quot;</span>) &amp;&amp; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/srow_y&quot;</span>) &amp;&amp; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/srow_z&quot;</span>)){
<a name="l00214"></a>00214                 props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_x&quot;</span>).copyTo(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>);
<a name="l00215"></a>00215                 props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_y&quot;</span>).copyTo(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>);
<a name="l00216"></a>00216                 props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_z&quot;</span>).copyTo(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>);
<a name="l00217"></a>00217             }
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219         <span class="comment">// store niftis original qform if its there</span>
<a name="l00220"></a>00220         <span class="keywordflow">if</span>(props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/qform_code&quot;</span>)){
<a name="l00221"></a>00221             head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a>=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">short</span>&gt;(<span class="stringliteral">&quot;nifti/qform_code&quot;</span>);
<a name="l00222"></a>00222             <span class="keywordflow">if</span>( props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/quatern_b&quot;</span>) &amp;&amp; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/quatern_c&quot;</span>) &amp;&amp; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/quatern_d&quot;</span>) &amp;&amp;
<a name="l00223"></a>00223                 props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/qoffset&quot;</span>) &amp;&amp; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a2c5d3ce156eed680db8883694be2bb67" title="check if property is available">hasProperty</a>(<span class="stringliteral">&quot;nifti/qfac&quot;</span>)
<a name="l00224"></a>00224             ){
<a name="l00225"></a>00225                 <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a> offset=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/qoffset&quot;</span>);
<a name="l00226"></a>00226                 head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">quatern_b</a> = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;nifti/quatern_b&quot;</span>);
<a name="l00227"></a>00227                 head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">quatern_c</a> = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;nifti/quatern_c&quot;</span>);
<a name="l00228"></a>00228                 head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">quatern_d</a> = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;nifti/quatern_d&quot;</span>);
<a name="l00229"></a>00229                 head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[0] = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">float</span>&gt;(<span class="stringliteral">&quot;nifti/qfac&quot;</span>);
<a name="l00230"></a>00230                 head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">qoffset_x</a>=offset[0];head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">qoffset_y</a>=offset[1];head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">qoffset_z</a>=offset[2];
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <span class="comment">//store current orientation (may override values set above)</span>
<a name="l00235"></a>00235         <span class="keywordflow">if</span>(!storeQForm(props,head)) <span class="comment">//try to encode as quaternion</span>
<a name="l00236"></a>00236             storeSForm(props,head); <span class="comment">//fall back to normal matrix</span>
<a name="l00237"></a>00237     }
<a name="l00238"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a1bccd1adfa9bc5f28406376e3395d979">00238</a>     <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a1bccd1adfa9bc5f28406376e3395d979">getHeader</a>(<span class="keyword">const</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *head,<a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;props){
<a name="l00239"></a>00239         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dims=head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0];
<a name="l00240"></a>00240         <span class="keywordtype">double</span> time_fac=1;
<a name="l00241"></a>00241         <span class="keywordtype">double</span> size_fac=1;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         <span class="keywordflow">switch</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> &amp; 0x07){
<a name="l00244"></a>00244             <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a58b8564584f3e2cda3bfb9daebdd28d5">NIFTI_UNITS_METER</a>:size_fac=1e3;<span class="keywordflow">break</span>;
<a name="l00245"></a>00245             <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a9ab584aac820e59dc2373581ee2c237e">NIFTI_UNITS_MICRON</a>:size_fac=1e-3;<span class="keywordflow">break</span>;
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <span class="keywordflow">switch</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> &amp; 0x38){
<a name="l00249"></a>00249             <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#ae1126a70acd21a99d7748c7ee9f877a8">NIFTI_UNITS_SEC</a>:time_fac=1e3;<span class="keywordflow">break</span>;
<a name="l00250"></a>00250             <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a17714a9f67cbf27371ee9dda4a046942">NIFTI_UNITS_USEC</a>:time_fac=1e-3;<span class="keywordflow">break</span>;
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;uint16_t&gt;(<span class="stringliteral">&quot;sequenceNumber&quot;</span>,0);
<a name="l00255"></a>00255         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;std::string&gt;(<span class="stringliteral">&quot;sequenceDescription&quot;</span>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a>);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Selection.html" title="Here, a Selection is one of our types (see types.hpp) and meant as an enumeration of &amp;quot;things&amp;quo...">util::Selection</a> formCode(<span class="stringliteral">&quot;SCANNER_ANAT,ALIGNED_ANAT,TALAIRACH,MNI_152&quot;</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> ) { <span class="comment">// get srow if sform_code&gt;0</span>
<a name="l00260"></a>00260             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/sform_code&quot;</span>, formCode )-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1Selection.html" title="Here, a Selection is one of our types (see types.hpp) and meant as an enumeration of &amp;quot;things&amp;quo...">util::Selection</a>&gt;().<span class="keyword">set</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a>);
<a name="l00261"></a>00261             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_x&quot;</span>, <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;().copyFrom(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>+4);;
<a name="l00262"></a>00262             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_y&quot;</span>, <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;().copyFrom(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>+4);;
<a name="l00263"></a>00263             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_z&quot;</span>, <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;().copyFrom(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>+4);;
<a name="l00264"></a>00264         }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> ) { <span class="comment">// get the quaternion if qform_code&gt;0</span>
<a name="l00267"></a>00267             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qform_code&quot;</span>, formCode )-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1Selection.html" title="Here, a Selection is one of our types (see types.hpp) and meant as an enumeration of &amp;quot;things&amp;quo...">util::Selection</a>&gt;().<span class="keyword">set</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a>);
<a name="l00268"></a>00268             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">quatern_b</a>);
<a name="l00269"></a>00269             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">quatern_c</a>);
<a name="l00270"></a>00270             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">quatern_d</a>);
<a name="l00271"></a>00271             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qoffset&quot;</span>, <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">qoffset_x</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">qoffset_y</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">qoffset_z</a>, 0 ) );
<a name="l00272"></a>00272             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qfac&quot;</span>, (head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0]==-1) ?:1 );
<a name="l00273"></a>00273 
<a name="l00274"></a>00274             <span class="comment">// voxel size</span>
<a name="l00275"></a>00275             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a> v_size;v_size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#a00afc94aa6452abf889ffddc4ebb76fd" title="copy the elements to somthing designed after the output iterator model">copyFrom</a>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>+1,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>+std::min&lt;unsigned short&gt;(dims,3)+1);
<a name="l00276"></a>00276             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/pixdim&quot;</span>,v_size*size_fac);
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         <span class="keywordflow">if</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a>){ <span class="comment">// if sform_code is set, use that regardless of qform</span>
<a name="l00280"></a>00280             useSForm(props);
<a name="l00281"></a>00281         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a>){ <span class="comment">// if qform_code is set, but no sform use that (thats the &quot;normal&quot; case)</span>
<a name="l00282"></a>00282             useQForm(props);
<a name="l00283"></a>00283         } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> ) &lt;&lt; <span class="stringliteral">&quot;Neither sform_code nor qform_code are set, using identity matrix for geometry&quot;</span>;
<a name="l00285"></a>00285             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span>,    nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aa648d9df8c08b23ddf8e3875b1357ded">getRow</a>(0) ); <span class="comment">// we use the transformation from nifti to isis as unity</span>
<a name="l00286"></a>00286             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span>, nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aa648d9df8c08b23ddf8e3875b1357ded">getRow</a>(1) ); <span class="comment">// because the image will very likely be in nifti space</span>
<a name="l00287"></a>00287             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span>,  nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aa648d9df8c08b23ddf8e3875b1357ded">getRow</a>(2) );
<a name="l00288"></a>00288             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[1],head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[2],head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[3]) );
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290         <span class="comment">// set space unit factors</span>
<a name="l00291"></a>00291         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;voxelSize&quot;</span>)-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;()*=size_fac;
<a name="l00292"></a>00292         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;indexOrigin&quot;</span>)-&gt;castTo&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;()*=size_fac;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="comment">// set slice ordering</span>
<a name="l00295"></a>00295         <span class="keywordflow">if</span>(dims==3){
<a name="l00296"></a>00296             <span class="keyword">const</span> <span class="keywordtype">int</span> interl[]={0,1,-1};
<a name="l00297"></a>00297             <span class="keywordflow">switch</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a>){
<a name="l00298"></a>00298                 <span class="keywordflow">case</span> 0:
<a name="l00299"></a>00299                 <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>:
<a name="l00300"></a>00300                     <span class="keywordflow">if</span>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>){ <span class="comment">// if there is no slice duration, and the sequence is &quot;normal&quot; there is no use in numbering</span>
<a name="l00301"></a>00301                         <span class="keywordflow">for</span>(uint32_t i=0;i&lt;head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3];i++){
<a name="l00302"></a>00302                             props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>,i)=i;
<a name="l00303"></a>00303                             props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionTime&quot;</span>,  i)=i*head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>*time_fac;
<a name="l00304"></a>00304                             }
<a name="l00305"></a>00305                     } <span class="keywordflow">else</span> {
<a name="l00306"></a>00306                         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>)=0;
<a name="l00307"></a>00307                     }
<a name="l00308"></a>00308                     <span class="keywordflow">break</span>;
<a name="l00309"></a>00309                 <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a4de04fa4c62c518259ea4b22c23661e8">NIFTI_SLICE_SEQ_DEC</a>:
<a name="l00310"></a>00310                     <span class="keywordflow">for</span>(uint32_t i=0;i&lt;head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3];i++){
<a name="l00311"></a>00311                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]-i-1)=i;
<a name="l00312"></a>00312                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionTime&quot;</span>,  head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]-i-1)=i*head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>*time_fac;
<a name="l00313"></a>00313                     }
<a name="l00314"></a>00314                     <span class="keywordflow">break</span>;
<a name="l00315"></a>00315                 <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a27dfca46abf4fa1c0c66b9612f34c790">NIFTI_SLICE_ALT_INC</a>:
<a name="l00316"></a>00316                     <span class="keywordflow">for</span>(uint32_t i=0;i&lt;head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3];i++){
<a name="l00317"></a>00317                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>,i)=i+interl[i%3];
<a name="l00318"></a>00318                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionTime&quot;</span>,  i)=(i+interl[i%3])*head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>*time_fac;
<a name="l00319"></a>00319                     }
<a name="l00320"></a>00320                     <span class="keywordflow">break</span>;
<a name="l00321"></a>00321                 <span class="keywordflow">case</span> <a class="code" href="imageFormat__Nifti__SA_8cpp.html#a142ac8b09c85f608a96e01e795be1e62">NIFTI_SLICE_ALT_DEC</a>:
<a name="l00322"></a>00322                     <span class="keywordflow">for</span>(uint32_t i=0;i&lt;head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3];i++){
<a name="l00323"></a>00323                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionNumber&quot;</span>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]-i-1)=i+interl[i%3];
<a name="l00324"></a>00324                         props.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab79d587ce667ae839c2343f91bfe7080" title="Access properties of the next lower dimension (e.g.">propertyValueAt</a>(<span class="stringliteral">&quot;acquisitionTime&quot;</span>,  head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]-i-1)=(i+interl[i%3])*head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>*time_fac;
<a name="l00325"></a>00325                     }
<a name="l00326"></a>00326                     <span class="keywordflow">break</span>;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328                 <span class="keywordflow">default</span>:<a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a>) &lt;&lt; <span class="stringliteral">&quot;Unknown slice code &quot;</span> &lt;&lt; <a class="code" href="classisis_1_1util_1_1MSubject.html">util::MSubject</a>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a>);<span class="keywordflow">break</span>;
<a name="l00329"></a>00329             }
<a name="l00330"></a>00330         } <span class="keywordflow">else</span> {
<a name="l00331"></a>00331             <a class="code" href="log_8hpp.html#a977f6c27373576d6ffe1523fc2afb8b6">LOG_IF</a>(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a>,<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a>) &lt;&lt; <span class="stringliteral">&quot;Sorry slice_code!=0 is currently only supportet for 3D-images, ignoring it.&quot;</span>;
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="comment">// Tr</span>
<a name="l00335"></a>00335         <span class="keywordflow">if</span>(dims&gt;4)
<a name="l00336"></a>00336             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;uint16_t&gt;(<span class="stringliteral">&quot;repetitionTime&quot;</span>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[4]*time_fac);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="comment">// sequenceDescription</span>
<a name="l00339"></a>00339         <span class="keywordflow">if</span>(!<a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a399ad6a6ec1d8dcfa3581a49e721064e">parseDescripForSPM</a>(props, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a>)) <span class="comment">// if descrip dos not hold Te,Tr and stuff (SPM dialect)</span>
<a name="l00340"></a>00340             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;std::string&gt;(<span class="stringliteral">&quot;sequenceDescription&quot;</span>,head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a>);<span class="comment">// use it the usual way</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="comment">// TODO: at the moment scaling not supported due to data type changes</span>
<a name="l00343"></a>00343         <span class="keywordflow">if</span> ( !(head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">scl_slope</a> == 1 || head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a570f6c8dc72f63af277406d0a84ca604">scl_inter</a>==0) ) {
<a name="l00344"></a>00344             <span class="comment">//          throwGenericError( std::string( &quot;Scaling is not supported at the moment. Scale Factor: &quot; ) + util::Value&lt;float&gt;( scale ).toString() );</span>
<a name="l00345"></a>00345             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Scaling is not supported at the moment.&quot;</span>;
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="keyword">public</span>:
<a name="l00353"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fc2a1f94333c4a40f1034319fa769aa">00353</a>     std::string <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fc2a1f94333c4a40f1034319fa769aa">getName</a>()<span class="keyword">const </span>{<span class="keywordflow">return</span> <span class="stringliteral">&quot;Nifti standalone&quot;</span>;}
<a name="l00354"></a>00354 
<a name="l00355"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#afaa8baba07d100ecf3816a22d9c9976c">00355</a>     <span class="keywordtype">int</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#afaa8baba07d100ecf3816a22d9c9976c">load</a> ( std::list&lt;data::Chunk&gt; &amp;chunks, <span class="keyword">const</span> std::string &amp;filename, <span class="keyword">const</span> std::string &amp;<span class="comment">/*dialect*/</span> )  throw( std::runtime_error &amp; ) {
<a name="l00356"></a>00356         <a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a> mfile(filename);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         <span class="comment">//get the header - we use it directly from the file</span>
<a name="l00359"></a>00359         <span class="keyword">const</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *header= <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a>*<span class="keyword">&gt;</span>(&amp;mfile[0]);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="keywordflow">if</span>(header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">intent_code</a>!=0){
<a name="l00362"></a>00362             throwGenericError(std::string(<span class="stringliteral">&quot;only intent_code==0 is supportet&quot;</span>));
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="comment">//set up the size - copy dim[0] values from dim[1]..dim[dim[0]]</span>
<a name="l00366"></a>00366         <a class="code" href="classisis_1_1util_1_1FixedVector.html">util::FixedVector&lt;size_t,4&gt;</a> size;
<a name="l00367"></a>00367         size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#af94746a0cc9eb0e48a2a71da0e3a56c6" title="Set all elements to a value.">fill</a>(1);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#a00afc94aa6452abf889ffddc4ebb76fd" title="copy the elements to somthing designed after the output iterator model">copyFrom</a>(header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>+1,header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>+1+header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0]);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">data::ValuePtrReference</a> data=mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#a7d6c697583f387058dc0d5afb1e587f8" title="Get a ValuePtrReference to a ValuePtr of the requested type.">atByID</a>(<a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a26129b11bd988dc47dc60ad1a5de7710">nifti_type2isis_type</a>[header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a>],header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>);
<a name="l00372"></a>00372         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Mapping nifti image as &quot;</span> &lt;&lt; data-&gt;getTypeName() &lt;&lt; <span class="stringliteral">&quot; of length &quot;</span> &lt;&lt; data-&gt;getLength();
<a name="l00373"></a>00373         <a class="code" href="log_8hpp.html#a977f6c27373576d6ffe1523fc2afb8b6">LOG_IF</a>((<span class="keywordtype">size_t</span>)header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a>!=data-&gt;bytesPerElem()*8,<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a>)
<a name="l00374"></a>00374             &lt;&lt; <span class="stringliteral">&quot;nifti field bitpix does not fit the bytesize of the given datatype (&quot;</span>
<a name="l00375"></a>00375             &lt;&lt; data-&gt;getTypeName() &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a> &lt;&lt;  <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         chunks.push_back(<a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a>(data,size[0],size[1],size[2],size[3]));
<a name="l00378"></a>00378         <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a1bccd1adfa9bc5f28406376e3395d979">getHeader</a>(header,chunks.back());
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="keywordflow">return</span> 1;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fd192a16f8088bd3a2ce01b49933853">00383</a>     <span class="keywordtype">void</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fd192a16f8088bd3a2ce01b49933853">write</a>( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;image, <span class="keyword">const</span> std::string &amp;filename, <span class="keyword">const</span> std::string &amp;dialect )  <span class="keywordflow">throw</span>( std::runtime_error &amp; ) {
<a name="l00384"></a>00384         <span class="keyword">class </span>CopyOp:<span class="keyword">public</span> data::ChunkOp{
<a name="l00385"></a>00385             <a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a> &amp;m_out;
<a name="l00386"></a>00386             <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;m_image;
<a name="l00387"></a>00387             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> m_ID;
<a name="l00388"></a>00388             <span class="keyword">const</span> <span class="keywordtype">size_t</span> m_bytesPerPixel;
<a name="l00389"></a>00389             <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1data.html#ac2873e5e7a9637d4ac68253dcf140ff4">data::scaling_pair</a> m_scale;
<a name="l00390"></a>00390         <span class="keyword">public</span>:
<a name="l00391"></a>00391             CopyOp(<span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;image,<a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a> &amp;out):
<a name="l00392"></a>00392                 m_image(image),m_out(out),m_ID(image.<a class="code" href="classisis_1_1data_1_1Image.html#a601eaac6eedf7eaf6fdb6c31b1e8765d" title="Get the type of the chunk with &amp;quot;biggest&amp;quot; type.">getMajorTypeID</a>()),m_bytesPerPixel(image.<a class="code" href="classisis_1_1data_1_1Image.html#a873a72def2728e8cfc060ee8c6ac6bd3" title="get the size of every voxel (in bytes)">getBytesPerVoxel</a>()),m_scale(image.<a class="code" href="classisis_1_1data_1_1Image.html#a789138e66345f3e5a73c65dbf05b2940" title="for each chunk get the scaling (and offset) which would be used in an conversion to the given type...">getScalingTo</a>( m_ID )){}
<a name="l00393"></a>00393             <span class="keywordtype">bool</span> operator()(<a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;ch, <a class="code" href="classisis_1_1util_1_1FixedVector.html">util::FixedVector&lt; size_t, 4 &gt;</a> posInImage){
<a name="l00394"></a>00394                 <span class="keywordtype">size_t</span> offset=384+m_image.getLinearIndex(posInImage)*m_bytesPerPixel;
<a name="l00395"></a>00395                 <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">data::ValuePtrReference</a> out_data=m_out.atByID(m_ID,offset,ch.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a5268e73b64b56929ec91d15204e29b4a" title="Get the size of the object in elements of TYPE.">getVolume</a>());
<a name="l00396"></a>00396                 ch.<a class="code" href="classisis_1_1data_1_1Chunk.html#a944f364baa18675dbd1c8f4c6b3f8d73">asValuePtrBase</a>().copyTo(*out_data,m_scale);
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398         };
<a name="l00399"></a>00399         
<a name="l00400"></a>00400         <span class="keyword">const</span> <span class="keywordtype">size_t</span> bpv=image.getBytesPerVoxel();
<a name="l00401"></a>00401         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> target_id=image.getMajorTypeID();
<a name="l00402"></a>00402 
<a name="l00403"></a>00403         <span class="keywordflow">if</span>(<a class="code" href="namespaceisis_1_1util.html#a85956c20207215d2b77e4c0935e494d5">util::istring</a>(dialect.c_str())==<span class="stringliteral">&quot;fsl&quot;</span>){
<a name="l00404"></a>00404             <span class="keywordflow">switch</span>(target_id){
<a name="l00405"></a>00405                 <span class="keywordflow">case</span> <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint16_t&gt;::staticID</a>:target_id=typeFallBack&lt;uint16_t&gt;();<span class="keywordflow">break</span>;
<a name="l00406"></a>00406                 <span class="keywordflow">case</span> <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint32_t&gt;::staticID</a>:target_id=typeFallBack&lt;uint32_t&gt;();<span class="keywordflow">break</span>;
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409         
<a name="l00410"></a>00410         <span class="keyword">const</span> <span class="keywordtype">size_t</span> datasize=image.getVolume()*bpv;
<a name="l00411"></a>00411         <span class="keywordflow">if</span>(<a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2fe1ad4a0e93a12d8484915e43107789">isis_type2nifti_type</a>[target_id]){ <span class="comment">// &quot;normal types&quot;</span>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             <span class="comment">// open/map the new file</span>
<a name="l00414"></a>00414             <a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a> out(filename,datasize+384,<span class="keyword">true</span>);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416             <span class="comment">// get the first 384 bytes as header</span>
<a name="l00417"></a>00417             <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *header= <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a>*<span class="keyword">&gt;</span>(&amp;out[0]);
<a name="l00418"></a>00418             memset(header,0,<span class="keyword">sizeof</span>(<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a>));
<a name="l00419"></a>00419 
<a name="l00420"></a>00420             <span class="comment">// set the datatype</span>
<a name="l00421"></a>00421             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a>=header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>=<span class="keyword">sizeof</span>(<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a>);
<a name="l00422"></a>00422             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a>=bpv*8;
<a name="l00423"></a>00423             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a>=<a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2fe1ad4a0e93a12d8484915e43107789">isis_type2nifti_type</a>[target_id];
<a name="l00424"></a>00424 
<a name="l00425"></a>00425             <span class="comment">// store the image size in dim and fill up the rest with &quot;1&quot; (to prevent fsl from exploding)</span>
<a name="l00426"></a>00426             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0]=image.getRelevantDims();
<a name="l00427"></a>00427             image.getSizeAsVector().copyTo(header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>+1);
<a name="l00428"></a>00428             std::fill(header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>+5,header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>+8,1);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430             <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a2061cef33b0436a0e979a7e243e17367">guessSliceOrdering</a>(image,header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a>,header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a>);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432             std::pair&lt; float, float &gt; minmax=image.getMinMaxAs&lt;<span class="keywordtype">float</span>&gt;();
<a name="l00433"></a>00433             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">cal_min</a>=minmax.first;header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">cal_max</a>=minmax.second;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435             CopyOp do_copy(image,out);
<a name="l00436"></a>00436             <span class="keyword">const_cast&lt;</span><a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a>&amp;<span class="keyword">&gt;</span>( image).foreachChunk(do_copy); <span class="comment">// @todo we _do_ need a const version of foreachChunk/Voxel</span>
<a name="l00437"></a>00437         } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a>) &lt;&lt; <span class="stringliteral">&quot;Sorry, the datatype &quot;</span> &lt;&lt; <a class="code" href="classisis_1_1util_1_1MSubject.html">util::MSubject</a>( image.getMajorTypeName() )&lt;&lt; <span class="stringliteral">&quot; is not supportet for nifti output&quot;</span>;
<a name="l00439"></a>00439             throwGenericError(<span class="stringliteral">&quot;unsupported datatype&quot;</span>);
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     }
<a name="l00443"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a72e29e35f46e6c4690841fc872074277">00443</a>     <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a72e29e35f46e6c4690841fc872074277">tainted</a>()<span class="keyword">const </span>{<span class="keywordflow">return</span> <span class="keyword">false</span>;}<span class="comment">//internal plugins are not tainted</span>
<a name="l00444"></a>00444 <span class="keyword">private</span>:
<a name="l00445"></a>00445     <span class="keyword">static</span> <span class="keywordtype">void</span> useSForm(<a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">util::PropertyMap</a> &amp;props){
<a name="l00446"></a>00446         <span class="comment">// srow_? is the linear map from image space to nifti space (not isis space)</span>
<a name="l00447"></a>00447         <span class="comment">// [x] [ nifti/srow_x ]   [i]</span>
<a name="l00448"></a>00448         <span class="comment">// [y]=[ nifti/srow_y ] * [j]</span>
<a name="l00449"></a>00449         <span class="comment">// [z] [ nifti/srow_z ]   [k]</span>
<a name="l00450"></a>00450 
<a name="l00451"></a>00451         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Using sform (&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;nifti/sform_code&quot;</span>).toString() &lt;&lt; <span class="stringliteral">&quot;) &quot;</span> &lt;&lt; <a class="code" href="classisis_1_1util_1_1MSubject.html">util::MSubject</a>(
<a name="l00452"></a>00452             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/srow_x&quot;</span>).toString()+<span class="stringliteral">&quot;-&quot;</span>+
<a name="l00453"></a>00453             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/srow_y&quot;</span>).toString()+<span class="stringliteral">&quot;-&quot;</span>+
<a name="l00454"></a>00454             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/srow_z&quot;</span>).toString()
<a name="l00455"></a>00455         ) &lt;&lt; <span class="stringliteral">&quot; to calc orientation&quot;</span>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00458"></a>00458         <span class="comment">// transform from image space to nifti space</span>
<a name="l00459"></a>00459         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;float&gt;</a> image2nifti(
<a name="l00460"></a>00460             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_x&quot;</span>),
<a name="l00461"></a>00461             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_y&quot;</span>),
<a name="l00462"></a>00462             props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/srow_z&quot;</span>)
<a name="l00463"></a>00463         );
<a name="l00464"></a>00464         <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;float&gt;</a> image2isis=nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#abeafe3fd60bc78822f2a82679e921a56">dot</a>(image2nifti); <span class="comment">// add transform to isis-space</span>
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         <span class="comment">//get position of image-voxel 0,0,0,0 in isis space</span>
<a name="l00467"></a>00467         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a> origin=image2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#abeafe3fd60bc78822f2a82679e921a56">dot</a>(<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(0,0,0,1));
<a name="l00468"></a>00468         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;indexOrigin&quot;</span>,origin)-&gt;castTo&lt;util::fvector4&gt;()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>]=0; <span class="comment">// timedim is 1 from the matrix calc</span>
<a name="l00469"></a>00469         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Computed indexOrigin=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;indexOrigin&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         <span class="comment">//remove offset from image2isis</span>
<a name="l00472"></a>00472         image2isis=<a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;float&gt;</a>(
<a name="l00473"></a>00473             <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>(1,0,0,-origin[0]),
<a name="l00474"></a>00474             <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>(0,1,0,-origin[1]),
<a name="l00475"></a>00475             <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>(0,0,1,-origin[2])
<a name="l00476"></a>00476         ).dot(image2isis);
<a name="l00477"></a>00477         
<a name="l00478"></a>00478         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a> voxelSize( <span class="comment">// get voxel sizes by transforming othogonal vectors of one voxel from image to isis</span>
<a name="l00479"></a>00479             image2isis.<a class="code" href="classisis_1_1util_1_1FixedVector.html#ab9fb48f1043227af14e78eb9a6622192" title="Get the inner product.">dot</a>(<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(1,0,0)).len(),
<a name="l00480"></a>00480             image2isis.<a class="code" href="classisis_1_1util_1_1FixedVector.html#ab9fb48f1043227af14e78eb9a6622192" title="Get the inner product.">dot</a>(<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(0,1,0)).len(),
<a name="l00481"></a>00481             image2isis.<a class="code" href="classisis_1_1util_1_1FixedVector.html#ab9fb48f1043227af14e78eb9a6622192" title="Get the inner product.">dot</a>(<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(0,0,1)).len()
<a name="l00482"></a>00482         );
<a name="l00483"></a>00483         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;voxelSize&quot;</span>,voxelSize)-&gt;castTo&lt;util::fvector4&gt;()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>]=0; <span class="comment">// timedim is 1 from the matrix calc</span>
<a name="l00484"></a>00484         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Computed voxelSize=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;voxelSize&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="comment">//remove scaling from image2isis</span>
<a name="l00488"></a>00488         image2isis=image2isis.<a class="code" href="classisis_1_1util_1_1FixedVector.html#ab9fb48f1043227af14e78eb9a6622192" title="Get the inner product.">dot</a>(<a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;float&gt;</a>(
<a name="l00489"></a>00489             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(1/voxelSize[0],0,0),
<a name="l00490"></a>00490             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(0,1/voxelSize[1],0),
<a name="l00491"></a>00491             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(0,0,1/voxelSize[2])
<a name="l00492"></a>00492         ));
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;rowVec&quot;</span>,image2isis.transpose().getRow(0));
<a name="l00495"></a>00495         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;columnVec&quot;</span>,image2isis.transpose().getRow(1));
<a name="l00496"></a>00496         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;sliceVec&quot;</span>,image2isis.transpose().getRow(2));
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>)
<a name="l00499"></a>00499             &lt;&lt; <span class="stringliteral">&quot;Computed rowVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;rowVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00500"></a>00500             &lt;&lt; <span class="stringliteral">&quot;columnVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;columnVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; and &quot;</span>
<a name="l00501"></a>00501             &lt;&lt; <span class="stringliteral">&quot;sliceVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;sliceVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/srow_x&quot;</span>);
<a name="l00504"></a>00504         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/srow_y&quot;</span>);
<a name="l00505"></a>00505         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/srow_z&quot;</span>);
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507     <span class="keyword">static</span> <span class="keywordtype">void</span> useQForm(<a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">util::PropertyMap</a> &amp;props){
<a name="l00508"></a>00508         
<a name="l00509"></a>00509         <span class="comment">// orientation //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00510"></a>00510         <span class="comment">//see http://nifti.nimh.nih.gov/nifti-1/documentation/nifti1fields/nifti1fields_pages/quatern.html</span>
<a name="l00511"></a>00511         <span class="comment">//and http://nifti.nimh.nih.gov/nifti-1/documentation/nifti1fields/nifti1fields_pages/qformExt.jpg</span>
<a name="l00512"></a>00512         <span class="keywordtype">double</span> b=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span>);
<a name="l00513"></a>00513         <span class="keywordtype">double</span> c=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span>);
<a name="l00514"></a>00514         <span class="keywordtype">double</span> d=props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span>);
<a name="l00515"></a>00515         <span class="keywordtype">double</span> a=sqrt(1.0-(b*b+c*c+d*d));
<a name="l00516"></a>00516 
<a name="l00517"></a>00517         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>)
<a name="l00518"></a>00518             &lt;&lt; <span class="stringliteral">&quot;Using qform (&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;nifti/qform_code&quot;</span>).toString()
<a name="l00519"></a>00519             &lt;&lt; <span class="stringliteral">&quot;) quaternion=&quot;</span> &lt;&lt; <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>(a,b,c,d) &lt;&lt; <span class="stringliteral">&quot; with qfac=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/qfac&quot;</span>).toString()
<a name="l00520"></a>00520             &lt;&lt; <span class="stringliteral">&quot;, pixdim=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/pixdim&quot;</span>).toString()
<a name="l00521"></a>00521             &lt;&lt; <span class="stringliteral">&quot; and qoffset= &quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a056afb492b1bba931399de18b7faa7e8" title="Access the property referenced by the path-key.">propertyValue</a>(<span class="stringliteral">&quot;nifti/qoffset&quot;</span>).toString();
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;double&gt;</a> M(
<a name="l00524"></a>00524             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(a*a+b*b-c*c-d*d,2*b*c-2*a*d,2*b*d+2*a*c),
<a name="l00525"></a>00525             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(2*b*c+2*a*d,a*a+c*c-b*b-d*d,2*c*d-2*a*b),
<a name="l00526"></a>00526             <a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>(2*b*d-2*a*c,2*c*d+2*a*b,a*a+d*d-c*c-b*b)
<a name="l00527"></a>00527         );
<a name="l00528"></a>00528         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;double&gt;</a> image2isis=nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#abeafe3fd60bc78822f2a82679e921a56">dot</a>(M);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;rowVec&quot;</span>,image2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aec9c9a8893dd57372cc7ac1d43ea572f">transpose</a>().getRow(0));
<a name="l00531"></a>00531         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;columnVec&quot;</span>,image2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aec9c9a8893dd57372cc7ac1d43ea572f">transpose</a>().getRow(1));
<a name="l00532"></a>00532         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;sliceVec&quot;</span>,image2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#aec9c9a8893dd57372cc7ac1d43ea572f">transpose</a>().getRow(2));
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>)
<a name="l00535"></a>00535             &lt;&lt; <span class="stringliteral">&quot;Computed rowVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;rowVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00536"></a>00536             &lt;&lt; <span class="stringliteral">&quot;columnVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;columnVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; and &quot;</span>
<a name="l00537"></a>00537             &lt;&lt; <span class="stringliteral">&quot;sliceVec=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;sliceVec&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/quatern_b&quot;</span>);
<a name="l00540"></a>00540         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/quatern_c&quot;</span>);
<a name="l00541"></a>00541         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/quatern_d&quot;</span>);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543         <span class="comment">// indexOrigin //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00544"></a>00544         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a61e21dbea881e669cd9e0d3d507920b2" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;indexOrigin&quot;</span>,nifti2isis.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#abeafe3fd60bc78822f2a82679e921a56">dot</a>(props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/qoffset&quot;</span>)));
<a name="l00545"></a>00545         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Computed indexOrigin=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;indexOrigin&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00546"></a>00546         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a6fbd0ba499cd5085a69f7561fa56a17e" title="Remove the property adressed by the key.">remove</a>(<span class="stringliteral">&quot;nifti/qoffset&quot;</span>);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <span class="comment">// voxelSize //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00549"></a>00549         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abfb694cd5ae540db4e2693beb073a80c" title="Transform an existing property into another.">transform</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;nifti/pixdim&quot;</span>,<span class="stringliteral">&quot;voxelSize&quot;</span>);
<a name="l00550"></a>00550         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>(<a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>,<a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a>) &lt;&lt; <span class="stringliteral">&quot;Computed voxelSize=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#abcf0e682869605ab103504ab05fc7624" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::fvector4</a>&gt;(<span class="stringliteral">&quot;voxelSize&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00551"></a>00551     }
<a name="l00552"></a>00552     <span class="keyword">static</span> <span class="keywordtype">bool</span> storeQForm(<span class="keyword">const</span> util::PropertyMap &amp;props,_internal::nifti_1_header *head){
<a name="l00553"></a>00553         
<a name="l00554"></a>00554         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="keyword">static</span> <span class="keywordtype">void</span> storeSForm(<span class="keyword">const</span> util::PropertyMap &amp;props,_internal::nifti_1_header *head){
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559 };
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <span class="comment">// The nifti coord system:</span>
<a name="l00562"></a>00562 <span class="comment">// The (x,y,z) coordinates refer to the CENTER of a voxel.</span>
<a name="l00563"></a>00563 <span class="comment">// In methods 2 and 3, the (x,y,z) axes refer to a subject-based coordinate system, with +x = Right  +y = Anterior  +z = Superior.</span>
<a name="l00564"></a>00564 <span class="comment">// So, the transform from nifti to isis is:</span>
<a name="l00565"></a>00565 <span class="keyword">const</span> util::Matrix4x4&lt;short&gt; ImageFormat_NiftiSa::nifti2isis(
<a name="l00566"></a>00566     util::vector4&lt;short&gt;(-1, 0, 0, 0),
<a name="l00567"></a>00567     util::vector4&lt;short&gt;( 0,-1, 0, 0),
<a name="l00568"></a>00568     util::vector4&lt;short&gt;( 0, 0, 1, 0),
<a name="l00569"></a>00569     util::vector4&lt;short&gt;( 0, 0, 0, 1)
<a name="l00570"></a>00570 );
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00577"></a><a class="code" href="imageFormat__Nifti__SA_8cpp.html#aa8b483f374fb36a1a13eccaa9e5e70ab">00577</a> <a class="code" href="io__interface_8h.html#ad534fde7b54f25d7d340da0fbc40753f">isis::image_io::FileFormat</a> *<a class="code" href="io__interface_8h.html#a9fe54fdfd8fa19863f55927c0d089847">factory</a>()
<a name="l00578"></a>00578 {
<a name="l00579"></a>00579     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html">isis::image_io::ImageFormat_NiftiSa</a>();
<a name="l00580"></a>00580 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Oct 7 2011 18:02:30 for ISIS Core Library by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
