<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ISIS Core Library: /SCR/isis/lib/ImageIO/imageFormat_nifti_sa.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ISIS Core Library&#160;<span id="projectnumber">(r)</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/SCR/isis/lib/ImageIO/imageFormat_nifti_sa.cpp</h1>  </div>
</div>
<div class="contents">
<a href="imageFormat__nifti__sa_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;DataStorage/fileptr.hpp&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;boost/date_time/gregorian/gregorian.hpp&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="imageFormat__nifti__sa_8hpp.html">imageFormat_nifti_sa.hpp</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="keyword">namespace </span>isis
<a name="l00009"></a>00009 {
<a name="l00010"></a>00010 <span class="keyword">namespace </span>image_io
<a name="l00011"></a>00011 {
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="keyword">namespace </span>_internal
<a name="l00014"></a>00014 {
<a name="l00015"></a>00015 <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab2d3a12b214db2423ffe114bcdd99a26">WriteOp::WriteOp</a>( <span class="keyword">const</span> data::Image &amp;image, <span class="keywordtype">size_t</span> bitsPerVoxel, <span class="keywordtype">bool</span> doFlip ): data::_internal::NDimensional&lt;4&gt;( image ), m_doFlip( doFlip ), m_bpv( bitsPerVoxel )
<a name="l00016"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab2d3a12b214db2423ffe114bcdd99a26">00016</a> {
<a name="l00017"></a>00017     <span class="keywordflow">if</span>( doFlip ) {
<a name="l00018"></a>00018         <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> dummy( image );
<a name="l00019"></a>00019         flip_dim = dummy.<a class="code" href="classisis_1_1data_1_1Image.html#a153f570319fc42ea6f1123a5a5eb309c" title="Maps the given scanner Axis to the dimension with the minimal angle.">mapScannerAxisToImageDimension</a>( <a class="code" href="namespaceisis_1_1data.html#addc0484ee8054d9e855bbd264c978b99a2d3b0a88d3baa2206c283d49f1a90c55">data::z</a> );
<a name="l00020"></a>00020     }
<a name="l00021"></a>00021 }
<a name="l00022"></a>00022 <span class="keywordtype">size_t</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a06fe86f6ad9ac8a44f3d91681ff6b189">WriteOp::getDataSize</a>()
<a name="l00023"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a06fe86f6ad9ac8a44f3d91681ff6b189">00023</a> {
<a name="l00024"></a>00024     <span class="keywordtype">size_t</span> bitsize = <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a5268e73b64b56929ec91d15204e29b4a" title="Get the size of the object in elements of TYPE.">getVolume</a>() * <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#adb7d5c587fe7f6b50d36996edc35335b">m_bpv</a>;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026     <span class="keywordflow">if</span>( bitsize % 8 )
<a name="l00027"></a>00027         bitsize += 8;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029     <span class="keywordflow">return</span> bitsize / 8;
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ac908800a75e7d8f4f9ed2e8478bdb796">WriteOp::setOutput</a>( <span class="keyword">const</span> std::string &amp;filename, <span class="keywordtype">size_t</span> voxelstart )
<a name="l00033"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ac908800a75e7d8f4f9ed2e8478bdb796">00033</a> {
<a name="l00034"></a>00034     <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a> = <a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a>( filename, voxelstart + <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a06fe86f6ad9ac8a44f3d91681ff6b189">getDataSize</a>(), <span class="keyword">true</span> );
<a name="l00035"></a>00035     <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a8127142172440b87574be7fdade1cf12">m_voxelstart</a> = voxelstart;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037     <span class="keywordflow">if</span>( <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>.<a class="code" href="classisis_1_1data_1_1FilePtr.html#aef7b8afaf8f6f390c77fb1f9c76876d8">good</a>() ) {
<a name="l00038"></a>00038         <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">nifti_1_header</a> *header = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a1ba718c7173dc7d7c51e0c723004515e">getHeader</a>();
<a name="l00039"></a>00039         memset( header, 0, <span class="keyword">sizeof</span>( <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> ) );
<a name="l00040"></a>00040 
<a name="l00041"></a>00041         <span class="comment">// store the image size in dim and fill up the rest with &quot;1&quot; (to prevent fsl from exploding)</span>
<a name="l00042"></a>00042         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0] = <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ad5e59bb1c93f616a20be4c5ed5e818ff" title="get amount of relevant dimensions (last dim with size&amp;gt;1) e.g.">getRelevantDims</a>();
<a name="l00043"></a>00043         <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a498b4ebaa5ef654ebe41eacebe813e66" title="generates a FixedVector&amp;lt;DIMS&amp;gt; representing the size">getSizeAsVector</a>().copyTo( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a> + 1 );
<a name="l00044"></a>00044         std::fill( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a> + 5, header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a> + 8, 1 );
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         <span class="comment">//some nifti readers expect analyze fields, but for now we disable this</span>
<a name="l00047"></a>00047         <span class="comment">/*header-&gt;extents=16*1024;</span>
<a name="l00048"></a>00048 <span class="comment">        header-&gt;regular=&#39;r&#39;;</span>
<a name="l00049"></a>00049 <span class="comment">        memcpy(header-&gt;data_type,&quot;dsr        &quot;,10);*/</span>
<a name="l00050"></a>00050         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a> = 348; <span class="comment">// must be 348</span>
<a name="l00051"></a>00051         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a8127142172440b87574be7fdade1cf12">m_voxelstart</a>;
<a name="l00052"></a>00052         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a> = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#adb7d5c587fe7f6b50d36996edc35335b">m_bpv</a>;
<a name="l00053"></a>00053         <span class="keywordflow">return</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>.<a class="code" href="classisis_1_1data_1_1FilePtr.html#aef7b8afaf8f6f390c77fb1f9c76876d8">good</a>();
<a name="l00054"></a>00054     } <span class="keywordflow">else</span>
<a name="l00055"></a>00055         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">nifti_1_header</a> *<a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a1ba718c7173dc7d7c51e0c723004515e">WriteOp::getHeader</a>() {<span class="keywordflow">return</span> <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">nifti_1_header</a> *<span class="keyword">&gt;</span>( &amp;<a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>[0] );}
<a name="l00059"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a1ba718c7173dc7d7c51e0c723004515e">00059</a> 
<a name="l00060"></a>00060 <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab6419e832b6735014d72fe426b4a195d">WriteOp::operator()</a>( <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;ch, <a class="code" href="classisis_1_1util_1_1vector4.html">util::vector4&lt;size_t&gt;</a> posInImage )
<a name="l00061"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab6419e832b6735014d72fe426b4a195d">00061</a> {
<a name="l00062"></a>00062     <span class="keywordflow">if</span>( <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a0b76073ef0fb92651097cc454aaf5060">doCopy</a>( ch, posInImage ) )
<a name="l00063"></a>00063         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00064"></a>00064     <span class="keywordflow">else</span> {
<a name="l00065"></a>00065         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Failed to copy chunk at &quot;</span> &lt;&lt; posInImage;
<a name="l00066"></a>00066         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 <span class="keywordtype">void</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a767c5a54e5baff6d1c3d04253fb655f2">WriteOp::applyFlip</a> ( <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">isis::data::ValuePtrReference</a> dat, <a class="code" href="classisis_1_1util_1_1vector4.html">isis::util::vector4&lt; size_t &gt;</a> chunkSize )
<a name="l00070"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a767c5a54e5baff6d1c3d04253fb655f2">00070</a> {
<a name="l00071"></a>00071     <span class="keywordflow">if</span>( <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a0bc35447b664940e806ade2b284634e2">m_doFlip</a> ) {
<a name="l00072"></a>00072         <span class="comment">// wrap the copied part back into a Chunk to flip it</span>
<a name="l00073"></a>00073         <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> cp( dat, chunkSize[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a9f473e3b41b1b75c9c3f0428c2712178">data::rowDim</a>], chunkSize[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4d76e19bcda99794dc317e4dfacb2f3c">data::columnDim</a>], chunkSize[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a5ac8c76240726965f794dcedcb675d8e">data::sliceDim</a>], chunkSize[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] ); <span class="comment">// this is a cheap copy</span>
<a name="l00074"></a>00074         cp.<a class="code" href="classisis_1_1data_1_1Chunk.html#a1c9b1f32d102d104c2d3824ecfc867e1" title="Swaps the image along a dimension dim in image space.">swapAlong</a>( <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a82b8103095dcaa038381fd7321160c38">flip_dim</a> ); <span class="comment">// .. so changing its data, will also change the data we just copied</span>
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keyword">class </span><a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html">CommonWriteOp</a>: <span class="keyword">public</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html">WriteOp</a>
<a name="l00080"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html">00080</a> {
<a name="l00081"></a>00081     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> m_targetId;
<a name="l00082"></a>00082     <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1data.html#ac2873e5e7a9637d4ac68253dcf140ff4">data::scaling_pair</a> m_scale;
<a name="l00083"></a>00083 <span class="keyword">public</span>:
<a name="l00084"></a>00084     <a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#ad674954890a505872ab9433bac1462b0">CommonWriteOp</a>( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;image, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> targetId, <span class="keywordtype">size_t</span> bitsPerVoxel, <span class="keywordtype">bool</span> doFlip = <span class="keyword">false</span> ):
<a name="l00085"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#ad674954890a505872ab9433bac1462b0">00085</a>         <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab2d3a12b214db2423ffe114bcdd99a26">WriteOp</a>( image, bitsPerVoxel, doFlip ),
<a name="l00086"></a>00086         m_targetId( targetId ), m_scale( image.<a class="code" href="classisis_1_1data_1_1Image.html#a789138e66345f3e5a73c65dbf05b2940" title="for each chunk get the scaling (and offset) which would be used in an conversion to the given type...">getScalingTo</a>( m_targetId ) ) {}
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#a79c40f0fe85e4da89c362f66e17a55f5">doCopy</a>( <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;ch, <a class="code" href="classisis_1_1util_1_1vector4.html">util::vector4&lt;size_t&gt;</a> posInImage ) {
<a name="l00089"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#a79c40f0fe85e4da89c362f66e17a55f5">00089</a>         <span class="keywordtype">size_t</span> offset = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a8127142172440b87574be7fdade1cf12">m_voxelstart</a> + <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ada01b000f0bccc84df97c149b4b827e0" title="Compute linear index from n-dimensional index,.">getLinearIndex</a>( posInImage ) * <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#adb7d5c587fe7f6b50d36996edc35335b">m_bpv</a> / 8;
<a name="l00090"></a>00090         <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">data::ValuePtrReference</a> out_data = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>.<a class="code" href="classisis_1_1data_1_1FilePtr.html#a7301c37340f98591f769c26b796d81f1" title="Get a ValuePtrReference to a ValuePtr of the requested type.">atByID</a>( m_targetId, offset, ch.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a5268e73b64b56929ec91d15204e29b4a" title="Get the size of the object in elements of TYPE.">getVolume</a>() );
<a name="l00091"></a>00091         ch.<a class="code" href="classisis_1_1data_1_1Chunk.html#a944f364baa18675dbd1c8f4c6b3f8d73">asValuePtrBase</a>().copyTo( *out_data, m_scale );
<a name="l00092"></a>00092         <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a767c5a54e5baff6d1c3d04253fb655f2">applyFlip</a>( out_data, ch.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a498b4ebaa5ef654ebe41eacebe813e66" title="generates a FixedVector&amp;lt;DIMS&amp;gt; representing the size">getSizeAsVector</a>() );
<a name="l00093"></a>00093         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     <span class="keywordtype">short</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#a1f17906a8cd3bf72025b80a5fceff459">getTypeId</a>() {<span class="keywordflow">return</span> m_targetId;}
<a name="l00097"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1CommonWriteOp.html#a1f17906a8cd3bf72025b80a5fceff459">00097</a> };
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">class </span><a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html">FslRgbWriteOp</a>: <span class="keyword">public</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html">WriteOp</a>
<a name="l00100"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html">00100</a> {
<a name="l00101"></a>00101     <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1data.html#ac2873e5e7a9637d4ac68253dcf140ff4">data::scaling_pair</a> m_scale;
<a name="l00102"></a>00102     <span class="keyword">struct </span>VoxelCp: data::VoxelOp&lt;util::color24&gt; {
<a name="l00103"></a>00103         <span class="keywordtype">int</span> mode;
<a name="l00104"></a>00104         uint8_t *ptr;
<a name="l00105"></a>00105         <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab6419e832b6735014d72fe426b4a195d">operator()</a>( <a class="code" href="structisis_1_1util_1_1color.html" title="Class to store a rgb tripel of type T.">util::color24</a> &amp;vox, <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">isis::util::vector4&lt;size_t&gt;</a>&amp; <span class="comment">/*pos*/</span> ) {
<a name="l00106"></a>00106             <span class="keywordflow">switch</span>( mode ) {
<a name="l00107"></a>00107             <span class="keywordflow">case</span> 0:
<a name="l00108"></a>00108                 *ptr = vox.<a class="code" href="structisis_1_1util_1_1color.html#a2796b6dbf4be2eb625ae570d5f1a407a">r</a>;
<a name="l00109"></a>00109                 <span class="keywordflow">break</span>;
<a name="l00110"></a>00110             <span class="keywordflow">case</span> 1:
<a name="l00111"></a>00111                 *ptr = vox.<a class="code" href="structisis_1_1util_1_1color.html#aa6b5d1b2de5b75624c543ac5f2a8c74d">g</a>;
<a name="l00112"></a>00112                 <span class="keywordflow">break</span>;
<a name="l00113"></a>00113             <span class="keywordflow">case</span> 2:
<a name="l00114"></a>00114                 *ptr = vox.<a class="code" href="structisis_1_1util_1_1color.html#a3251b559ca69ad0760b102dca8c38a52">b</a>;
<a name="l00115"></a>00115                 <span class="keywordflow">break</span>;
<a name="l00116"></a>00116             }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118             ptr++;
<a name="l00119"></a>00119             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00120"></a>00120         }
<a name="l00121"></a>00121     };
<a name="l00122"></a>00122 <span class="keyword">public</span>:
<a name="l00123"></a>00123     <a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#aca0d7a3af343825497f96b38774b50b3">FslRgbWriteOp</a>( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;image ):
<a name="l00124"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#aca0d7a3af343825497f96b38774b50b3">00124</a>         <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab2d3a12b214db2423ffe114bcdd99a26">WriteOp</a>( image, 8 ), m_scale( <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">util::ValueReference</a>( <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint8_t&gt;</a>( 1 ) ), <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">util::ValueReference</a>( <a class="code" href="classisis_1_1util_1_1Value.html" title="Generic class for type aware variables.">util::Value&lt;uint8_t&gt;</a>( 0 ) ) ) {
<a name="l00125"></a>00125         assert( image.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a77f1e5850aceb61e0141f03ebfa0645f">getDimSize</a>( 3 ) == 1 ); <span class="comment">//make sure the image has only one timestep</span>
<a name="l00126"></a>00126         <span class="keywordtype">size_t</span> <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a9002217e0b6108bcfa016d6ed52aaafe">dims</a>[4];
<a name="l00127"></a>00127         image.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a498b4ebaa5ef654ebe41eacebe813e66" title="generates a FixedVector&amp;lt;DIMS&amp;gt; representing the size">getSizeAsVector</a>().copyTo( dims );
<a name="l00128"></a>00128         dims[3] = 3;
<a name="l00129"></a>00129         <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#aed41e361800d007912e85190f1c4452f" title="Initializes the size-vector.">init</a>( dims ); <span class="comment">// reset our shape to use 3 timesteps as colors</span>
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#a4220bdd911497ed69b60cfb97bd2ccbc">doCopy</a>( <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;src, <a class="code" href="classisis_1_1util_1_1vector4.html">util::vector4&lt;size_t&gt;</a> posInImage ) {
<a name="l00133"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#a4220bdd911497ed69b60cfb97bd2ccbc">00133</a>         <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> ch = src;
<a name="l00134"></a>00134         ch.<a class="code" href="classisis_1_1data_1_1Chunk.html#ae8607eff4f684c7934c9f4188a05e24c" title="Ensure, the chunk has the type with the requested ID.">convertToType</a>( <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;util::color24&gt;::staticID</a>, m_scale );
<a name="l00135"></a>00135         VoxelCp cp;
<a name="l00136"></a>00136         assert( posInImage[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] == 0 );
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         <span class="keywordflow">for</span>( ; posInImage[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] &lt; 3; posInImage[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>]++ ) { <span class="comment">//copy each color/timestep into m_out</span>
<a name="l00139"></a>00139             <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a8127142172440b87574be7fdade1cf12">m_voxelstart</a> + <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ada01b000f0bccc84df97c149b4b827e0" title="Compute linear index from n-dimensional index,.">getLinearIndex</a>( posInImage ) * <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#adb7d5c587fe7f6b50d36996edc35335b">m_bpv</a> / 8;
<a name="l00140"></a>00140             <a class="code" href="classisis_1_1data_1_1ValuePtr.html">data::ValuePtr&lt;uint8_t&gt;</a> out_data = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>.<a class="code" href="classisis_1_1data_1_1FilePtr.html#acefaa068f3f5932d109009560912b318" title="Get a ValuePtr representing the data in the file.">at</a>&lt;uint8_t&gt;( offset, ch.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a5268e73b64b56929ec91d15204e29b4a" title="Get the size of the object in elements of TYPE.">getVolume</a>() );
<a name="l00141"></a>00141             cp.ptr = &amp;out_data[0];
<a name="l00142"></a>00142             cp.mode = posInImage[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>];
<a name="l00143"></a>00143             ch.<a class="code" href="classisis_1_1data_1_1Chunk.html#a99e5865871bcb988bcfd60ce81dcbb2c" title="Run a functor on every Voxel in the chunk.">foreachVoxel</a>( cp );
<a name="l00144"></a>00144             assert( cp.ptr == &amp;out_data[0] + out_data.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>() );
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordtype">short</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#a45aa25e0de7d632d977cb24be4f89498">getTypeId</a>() {<span class="keywordflow">return</span> <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint8_t&gt;::staticID</a>;}
<a name="l00151"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1FslRgbWriteOp.html#a45aa25e0de7d632d977cb24be4f89498">00151</a> };
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="keyword">class </span><a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html">BitWriteOp</a>: <span class="keyword">public</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html">WriteOp</a>
<a name="l00154"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html">00154</a> {
<a name="l00155"></a>00155 <span class="keyword">public</span>:
<a name="l00156"></a>00156     <a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a51e64d5abaec195accc33f23361f1bfe">BitWriteOp</a>( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;image ): <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ab2d3a12b214db2423ffe114bcdd99a26">WriteOp</a>( image, 1 ) {}
<a name="l00157"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a51e64d5abaec195accc33f23361f1bfe">00157</a> 
<a name="l00158"></a>00158     <span class="keywordtype">bool</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a3a5d184e1e67092561531fae89d79943">doCopy</a>( <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> &amp;src, <a class="code" href="classisis_1_1util_1_1vector4.html">util::vector4&lt;size_t&gt;</a> posInImage ) {
<a name="l00159"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a3a5d184e1e67092561531fae89d79943">00159</a>         <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;bool&gt;</a> in_data = src.<a class="code" href="classisis_1_1data_1_1Chunk.html#a944f364baa18675dbd1c8f4c6b3f8d73">asValuePtrBase</a>().as&lt;<span class="keywordtype">bool</span>&gt;();
<a name="l00160"></a>00160         <span class="keyword">const</span> <span class="keywordtype">size_t</span> offset = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#a8127142172440b87574be7fdade1cf12">m_voxelstart</a> + <a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ada01b000f0bccc84df97c149b4b827e0" title="Compute linear index from n-dimensional index,.">getLinearIndex</a>( posInImage ) * <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#adb7d5c587fe7f6b50d36996edc35335b">m_bpv</a> ;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162         <a class="code" href="classisis_1_1data_1_1ValuePtr.html">data::ValuePtr&lt;uint8_t&gt;</a> out_data = <a class="code" href="classisis_1_1image__io_1_1__internal_1_1WriteOp.html#ae61b686e05bbbf6eef2ce06d8fda7ad4">m_out</a>.<a class="code" href="classisis_1_1data_1_1FilePtr.html#acefaa068f3f5932d109009560912b318" title="Get a ValuePtr representing the data in the file.">at</a>&lt;uint8_t&gt;( offset, in_data.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>() / 8 );
<a name="l00163"></a>00163         memset( &amp;out_data[0], 0, out_data.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>() );
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> i = 0; i &lt; in_data.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>(); i++ ) {
<a name="l00166"></a>00166             <span class="keyword">const</span> <span class="keywordtype">size_t</span> byte = i / 8;
<a name="l00167"></a>00167             <span class="keyword">const</span> uint8_t mask = 128 &gt;&gt; ( i % 8 );
<a name="l00168"></a>00168 
<a name="l00169"></a>00169             <span class="keywordflow">if</span>( in_data[i] ) {
<a name="l00170"></a>00170                 out_data[byte] |= mask;
<a name="l00171"></a>00171             }
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="keywordtype">short</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a268d42788495c355d98a52f7cdebc1cb">getTypeId</a>() {<span class="keywordflow">return</span> <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;bool&gt;::staticID</a>;}
<a name="l00178"></a><a class="code" href="classisis_1_1image__io_1_1__internal_1_1BitWriteOp.html#a268d42788495c355d98a52f7cdebc1cb">00178</a> };
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#abac02a5a0a75279ddefba6231e0aa9de">ImageFormat_NiftiSa::ImageFormat_NiftiSa</a>()
<a name="l00184"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#abac02a5a0a75279ddefba6231e0aa9de">00184</a> {
<a name="l00185"></a>00185     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a7ed8fda7096e3ff6d4051cd73d708688">NIFTI_TYPE_INT8</a> ] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt; int8_t&gt;::staticID</a>;
<a name="l00186"></a>00186     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a746b4eba0eaaac6366b232b46f590f48">NIFTI_TYPE_INT16</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int16_t&gt;::staticID</a>;
<a name="l00187"></a>00187     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a9bf4e01d93f73a1eaf8966f387e65999">NIFTI_TYPE_INT32</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int32_t&gt;::staticID</a>;
<a name="l00188"></a>00188     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a68fa86838cb29705b5a8ffc9ac158419">NIFTI_TYPE_INT64</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;int64_t&gt;::staticID</a>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a1ef0dc17948c65b6a7311fe96ddfc441">NIFTI_TYPE_UINT8</a> ] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt; uint8_t&gt;::staticID</a>;
<a name="l00191"></a>00191     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a253e4b750f2aa75a3efdac232663b85c">NIFTI_TYPE_UINT16</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint16_t&gt;::staticID</a>;
<a name="l00192"></a>00192     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a75125d71779526934b59d4d402b5fe10">NIFTI_TYPE_UINT32</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint32_t&gt;::staticID</a>;
<a name="l00193"></a>00193     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#ab8a45494d65119cdd94df359ee18b94b">NIFTI_TYPE_UINT64</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;uint64_t&gt;::staticID</a>;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a8220ccec425b9387abf3d2b71ac0be7e">NIFTI_TYPE_FLOAT32</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;float&gt;::staticID</a>;
<a name="l00196"></a>00196     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a1253a2540a68b4dd7a5d78bc8c4c2a4d">NIFTI_TYPE_FLOAT64</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;double&gt;::staticID</a>;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#abad329a29f5f3b65c1e4de114d7bb06b">NIFTI_TYPE_RGB24</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;util::color24&gt;::staticID</a>;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a9ae010c2ff48380fcb611c06048956c5">NIFTI_TYPE_COMPLEX64</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;std::complex&lt;float&gt;</a> &gt;::staticID;
<a name="l00201"></a>00201     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a65e61452b861209be2eb1a5a96556ca9">NIFTI_TYPE_COMPLEX128</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;std::complex&lt;double&gt;</a> &gt;::staticID;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     nifti_type2isis_type[<a class="code" href="imageFormat__nifti__sa_8hpp.html#a24d9052ecd00b9ad2b2f3113323ecd83">NIFTI_TYPE_BINARY</a>] = <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;bool&gt;::staticID</a>;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="keyword">typedef</span> std::map&lt;short, unsigned short&gt;::const_reference ref_type;
<a name="l00206"></a>00206     BOOST_FOREACH( ref_type ref, nifti_type2isis_type ) {
<a name="l00207"></a>00207         isis_type2nifti_type[ref.second] = ref.first;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 std::string <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a97c4d3fbc654012f6977170885a0d257">ImageFormat_NiftiSa::suffixes</a>( io_modes <span class="comment">/*mode*/</span> )<span class="keyword">const </span>{<span class="keywordflow">return</span> std::string( <span class="stringliteral">&quot;.nii&quot;</span> );}
<a name="l00212"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a97c4d3fbc654012f6977170885a0d257">00212</a> 
<a name="l00213"></a>00213 <span class="keywordtype">void</span> ImageFormat_NiftiSa::guessSliceOrdering( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> img, <span class="keywordtype">char</span> &amp;slice_code, <span class="keywordtype">float</span> &amp;slice_duration )
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span>( img.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0, 0, 0, <span class="keyword">false</span> ).getRelevantDims() == img.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ad5e59bb1c93f616a20be4c5ed5e818ff" title="get amount of relevant dimensions (last dim with size&amp;gt;1) e.g.">getRelevantDims</a>() ) { <span class="comment">// seems like there is only one chunk - slice ordering doesnt matter - just choose NIFTI_SLICE_SEQ_INC</span>
<a name="l00217"></a>00217         slice_code = <a class="code" href="imageFormat__nifti__sa_8hpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>;
<a name="l00218"></a>00218     } <span class="keywordflow">else</span> {
<a name="l00219"></a>00219         <a class="code" href="structisis_1_1util_1_1PropertyMap_1_1PropPath.html">util::PropertyMap::PropPath</a> order = img.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0, 0, 0, <span class="keyword">false</span> ).hasProperty( <span class="stringliteral">&quot;acquisitionTime&quot;</span> ) ? <span class="stringliteral">&quot;acquisitionTime&quot;</span> : <span class="stringliteral">&quot;acquisitionNumber&quot;</span>;
<a name="l00220"></a>00220         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1PropertyValue.html" title="A very generic class to store values of properties.">util::PropertyValue</a> first = img.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0, 0, 0, <span class="keyword">false</span> ).propertyValue( order ); <span class="comment">// acquisitionNumber _must_ be chunk-unique - so it is there even without a join</span>
<a name="l00221"></a>00221         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1PropertyValue.html" title="A very generic class to store values of properties.">util::PropertyValue</a> second = img.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0, 1, 0, <span class="keyword">false</span> ).propertyValue( order );
<a name="l00222"></a>00222         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1PropertyValue.html" title="A very generic class to store values of properties.">util::PropertyValue</a> middle = img.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0, img.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a498b4ebaa5ef654ebe41eacebe813e66" title="generates a FixedVector&amp;lt;DIMS&amp;gt; representing the size">getSizeAsVector</a>()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a5ac8c76240726965f794dcedcb675d8e">data::sliceDim</a>] / 2 + .5, 0, false ).propertyValue( order );
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="keywordflow">if</span>( first-&gt;gt( *second ) ) { <span class="comment">// second slice has a lower number than the first =&gt; decrementing</span>
<a name="l00225"></a>00225             <span class="keywordflow">if</span>( middle-&gt;gt( *second ) ) { <span class="comment">// if the middle number is greater than the second its interleaved</span>
<a name="l00226"></a>00226                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00227"></a>00227                         &lt;&lt; <span class="stringliteral">&quot;The \&quot;middle\&quot; &quot;</span> &lt;&lt; order &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; middle.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>() &lt;&lt; <span class="stringliteral">&quot;) is greater than the second (&quot;</span> &lt;&lt; second.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>()
<a name="l00228"></a>00228                         &lt;&lt; <span class="stringliteral">&quot;) assuming decrementing interleaved slice order&quot;</span>;
<a name="l00229"></a>00229                 slice_code = <a class="code" href="imageFormat__nifti__sa_8hpp.html#a142ac8b09c85f608a96e01e795be1e62">NIFTI_SLICE_ALT_DEC</a>;
<a name="l00230"></a>00230             } <span class="keywordflow">else</span> { <span class="comment">// assume &quot;normal&quot; otherwise</span>
<a name="l00231"></a>00231                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00232"></a>00232                         &lt;&lt; <span class="stringliteral">&quot;The first &quot;</span> &lt;&lt; order &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; first.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>() &lt;&lt; <span class="stringliteral">&quot;) is greater than the second (&quot;</span> &lt;&lt; second.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>()
<a name="l00233"></a>00233                         &lt;&lt; <span class="stringliteral">&quot;) assuming decrementing slice order&quot;</span>;
<a name="l00234"></a>00234                 slice_code = <a class="code" href="imageFormat__nifti__sa_8hpp.html#a4de04fa4c62c518259ea4b22c23661e8">NIFTI_SLICE_SEQ_DEC</a>;
<a name="l00235"></a>00235             }
<a name="l00236"></a>00236         } <span class="keywordflow">else</span> { <span class="comment">// assume incrementing</span>
<a name="l00237"></a>00237             <span class="keywordflow">if</span>( middle-&gt;lt( *second ) ) { <span class="comment">// if the middle number is less than the second ist interleaved</span>
<a name="l00238"></a>00238                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00239"></a>00239                         &lt;&lt; <span class="stringliteral">&quot;The \&quot;middle\&quot; &quot;</span> &lt;&lt; order &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; middle.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>() &lt;&lt; <span class="stringliteral">&quot;) is less than the second (&quot;</span> &lt;&lt; second.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>()
<a name="l00240"></a>00240                         &lt;&lt; <span class="stringliteral">&quot;) assuming incrementing interleaved slice order&quot;</span>;
<a name="l00241"></a>00241                 slice_code = <a class="code" href="imageFormat__nifti__sa_8hpp.html#a27dfca46abf4fa1c0c66b9612f34c790">NIFTI_SLICE_ALT_INC</a>;
<a name="l00242"></a>00242             } <span class="keywordflow">else</span> { <span class="comment">// assume &quot;normal&quot; otherwise</span>
<a name="l00243"></a>00243                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00244"></a>00244                         &lt;&lt; <span class="stringliteral">&quot;The first &quot;</span> &lt;&lt; order &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; first.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>() &lt;&lt; <span class="stringliteral">&quot;) is not greater than the second (&quot;</span> &lt;&lt; second.<a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html#a35698cbb884b974df8fc2d18a01aef4d">toString</a>()
<a name="l00245"></a>00245                         &lt;&lt; <span class="stringliteral">&quot;) assuming incrementing slice order&quot;</span>;
<a name="l00246"></a>00246                 slice_code = <a class="code" href="imageFormat__nifti__sa_8hpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>;
<a name="l00247"></a>00247             }
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         slice_duration = fabs( second-&gt;as&lt;<span class="keywordtype">float</span>&gt;() - second-&gt;as&lt;<span class="keywordtype">float</span>&gt;() );
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="keywordflow">if</span>( slice_code == <a class="code" href="imageFormat__nifti__sa_8hpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a> || slice_code == <a class="code" href="imageFormat__nifti__sa_8hpp.html#a4de04fa4c62c518259ea4b22c23661e8">NIFTI_SLICE_SEQ_DEC</a> ) { <span class="comment">// if its interleaved there was another slice between 0 and 1</span>
<a name="l00253"></a>00253             slice_duration /= 2;
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 std::list&lt;data::Chunk&gt; ImageFormat_NiftiSa::parseSliceOrdering( <span class="keyword">const</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *head, <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a> current )
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordtype">double</span> time_fac;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="keywordflow">switch</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> &amp; 0x38 ) {
<a name="l00264"></a>00264     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#ae1126a70acd21a99d7748c7ee9f877a8">NIFTI_UNITS_SEC</a>:
<a name="l00265"></a>00265         time_fac = 1e3;
<a name="l00266"></a>00266         <span class="keywordflow">break</span>;
<a name="l00267"></a>00267     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a17714a9f67cbf27371ee9dda4a046942">NIFTI_UNITS_USEC</a>:
<a name="l00268"></a>00268         time_fac = 1e-3;
<a name="l00269"></a>00269         <span class="keywordflow">break</span>;
<a name="l00270"></a>00270     <span class="keywordflow">default</span>:
<a name="l00271"></a>00271         time_fac = 1;
<a name="l00272"></a>00272         <span class="keywordflow">break</span>;
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="comment">//if the sequence is &quot;normal&quot;</span>
<a name="l00276"></a>00276     current.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;uint32_t&gt;( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, 0 );
<a name="l00277"></a>00277     <span class="keyword">const</span> <span class="keywordtype">size_t</span> dims = current.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ad5e59bb1c93f616a20be4c5ed5e818ff" title="get amount of relevant dimensions (last dim with size&amp;gt;1) e.g.">getRelevantDims</a>();
<a name="l00278"></a>00278     assert( dims &lt;= 4 ); <span class="comment">// more than 4 dimenstions are ... well, not expected</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a> == 0 || head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a> == <a class="code" href="imageFormat__nifti__sa_8hpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a> ) {
<a name="l00281"></a>00281         <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> == 0 ) { <span class="comment">// and there is no slice duration, there is no use in numbering</span>
<a name="l00282"></a>00282             <span class="keywordflow">return</span> std::list&lt;data::Chunk&gt;( 1, current );
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="keywordflow">if</span>( dims &lt; 3 ) { <span class="comment">// if there is only one slice, there is no use in numbering</span>
<a name="l00287"></a>00287         <span class="keywordflow">return</span> std::list&lt;data::Chunk&gt;( 1, current );
<a name="l00288"></a>00288     } <span class="keywordflow">else</span> {<span class="comment">// if there are timesteps we have to get a bit dirty</span>
<a name="l00289"></a>00289         std::list&lt; data::Chunk &gt; newChList = ( dims == 4 ? current.<a class="code" href="classisis_1_1data_1_1Chunk.html#ab51fafa7cb8cbbfb4718c64628a3c245" title="Splices the chunk at the uppermost dimension and automatically sets indexOrigin and acquisitionNumber...">autoSplice</a>() : std::list&lt;data::Chunk&gt;( 1, current ) ); <span class="comment">// make sure we have a list of 3D-Chunks</span>
<a name="l00290"></a>00290         uint32_t offset = 0;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         BOOST_FOREACH( data::Chunk &amp; ch, newChList ) {
<a name="l00293"></a>00293 
<a name="l00294"></a>00294             <span class="keywordflow">switch</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a> ) { <span class="comment">//set sub-property &quot;acquisitionNumber&quot; based on the slice_code and the offset</span>
<a name="l00295"></a>00295             <span class="keywordflow">case</span> 0:
<a name="l00296"></a>00296             <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#ad1f3084d4febc60e2d64d85d72907e8a">NIFTI_SLICE_SEQ_INC</a>:
<a name="l00297"></a>00297 
<a name="l00298"></a>00298                 <span class="keywordflow">for</span>( uint32_t i = 0; i &lt; ( uint32_t )head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; i++ )
<a name="l00299"></a>00299                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, i ) = i + offset;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 <span class="keywordflow">break</span>;
<a name="l00302"></a>00302             <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a4de04fa4c62c518259ea4b22c23661e8">NIFTI_SLICE_SEQ_DEC</a>:
<a name="l00303"></a>00303 
<a name="l00304"></a>00304                 <span class="keywordflow">for</span>( uint32_t i = 0; i &lt; ( uint32_t )head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; i++ )
<a name="l00305"></a>00305                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3] - i - 1 ) = i + offset;
<a name="l00306"></a>00306 
<a name="l00307"></a>00307                 <span class="keywordflow">break</span>;
<a name="l00308"></a>00308             <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a27dfca46abf4fa1c0c66b9612f34c790">NIFTI_SLICE_ALT_INC</a>: {
<a name="l00309"></a>00309                 uint32_t i = 0, cnt;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311                 <span class="keywordflow">for</span>( cnt = 0; i &lt; floor( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3] / 2 + .5 ); i++, cnt += 2 )
<a name="l00312"></a>00312                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, i ) = cnt + offset;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314                 <span class="keywordflow">for</span>( cnt = 1; i &lt; ( uint32_t )head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; i++, cnt += 2 )
<a name="l00315"></a>00315                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, i ) = cnt + offset;
<a name="l00316"></a>00316             }
<a name="l00317"></a>00317             <span class="keywordflow">break</span>;
<a name="l00318"></a>00318             <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a142ac8b09c85f608a96e01e795be1e62">NIFTI_SLICE_ALT_DEC</a>: {
<a name="l00319"></a>00319                 uint32_t i = 0, cnt;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                 <span class="keywordflow">for</span>( cnt = 0; i &lt; floor( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3] / 2 + .5 ); i++, cnt += 2 )
<a name="l00322"></a>00322                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3] - i - 1 ) = cnt + offset;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324                 <span class="keywordflow">for</span>( cnt = 1; i &lt; ( uint32_t )head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; i++, cnt += 2 )
<a name="l00325"></a>00325                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3] - i - 1 ) = cnt + offset;
<a name="l00326"></a>00326             }
<a name="l00327"></a>00327             <span class="keywordflow">break</span>;
<a name="l00328"></a>00328             <span class="keywordflow">default</span>:
<a name="l00329"></a>00329                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Unknown slice code &quot;</span> &lt;&lt; util::MSubject( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a> );
<a name="l00330"></a>00330                 <span class="keywordflow">break</span>;
<a name="l00331"></a>00331             }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> ) {
<a name="l00334"></a>00334                 <span class="keywordflow">for</span>( uint32_t i = 0; i &lt; ( uint32_t )head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; i++ ) { <span class="comment">// set su-property &quot;acquisitionTime&quot; based of the slice number</span>
<a name="l00335"></a>00335                     ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionTime&quot;</span>,  i ) = ch.propertyValueAt( <span class="stringliteral">&quot;acquisitionNumber&quot;</span>, i )-&gt;as&lt;<span class="keywordtype">float</span>&gt;() * head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> * time_fac;
<a name="l00336"></a>00336                 }
<a name="l00337"></a>00337             }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339             offset += head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[3]; <span class="comment">// increase offset by the number of slices per volume</span>
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341         <span class="keywordflow">return</span> newChList;
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="keywordtype">void</span> ImageFormat_NiftiSa::storeDescripForSPM( <span class="keyword">const</span> util::PropertyMap &amp;props, <span class="keywordtype">char</span> desc[] )
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348     std::list&lt;std::string&gt; ret;
<a name="l00349"></a>00349     <span class="keyword">typedef</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *prop_pair[3];
<a name="l00350"></a>00350     <span class="keyword">const</span> prop_pair  pairs[] = {{<span class="stringliteral">&quot;TR&quot;</span>, <span class="stringliteral">&quot;repetitionTime&quot;</span>, <span class="stringliteral">&quot;ms&quot;</span>}, {<span class="stringliteral">&quot;TE&quot;</span>, <span class="stringliteral">&quot;echoTime&quot;</span>, <span class="stringliteral">&quot;ms&quot;</span>}, {<span class="stringliteral">&quot;FA&quot;</span>, <span class="stringliteral">&quot;flipAngle&quot;</span>, <span class="stringliteral">&quot;deg&quot;</span>}, {<span class="stringliteral">&quot;timestamp&quot;</span>, <span class="stringliteral">&quot;sequenceStart&quot;</span>, <span class="stringliteral">&quot;&quot;</span>}};
<a name="l00351"></a>00351     BOOST_FOREACH( <span class="keyword">const</span> prop_pair &amp; p, pairs ) {
<a name="l00352"></a>00352         <span class="keywordflow">if</span>( props.hasProperty( p[1] ) ) {
<a name="l00353"></a>00353             ret.push_back( std::string( p[0] ) + <span class="stringliteral">&quot;=&quot;</span> + props.getPropertyAs&lt;std::string&gt;( p[1] ) + p[2] );
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     strncpy( desc, <a class="code" href="namespaceisis_1_1util.html#a8eedeaea8a5e6fb7849880fc5b4d4648" title="use listToOStream to create a string from a list">util::listToString</a>( ret.begin(), ret.end(), <span class="stringliteral">&quot;/&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span> ).c_str(), 80 );
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <span class="keywordtype">bool</span> ImageFormat_NiftiSa::parseDescripForSPM( <a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">isis::util::PropertyMap</a> &amp;props, <span class="keyword">const</span> <span class="keywordtype">char</span> desc[] )
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361     <span class="comment">//check description for tr, te and fa and date which is written by spm8</span>
<a name="l00362"></a>00362     boost::regex descriptionRegex(
<a name="l00363"></a>00363         <span class="stringliteral">&quot;.*TR=([[:digit:]]{1,})ms.*TE=([[:digit:]]{1,})ms.*FA=([[:digit:]]{1,})deg\\ *([[:digit:]]{1,2}).([[:word:]]{3}).([[:digit:]]{4})\\ *([[:digit:]]{1,2}):([[:digit:]]{1,2}):([[:digit:]]{1,2}).*&quot;</span>
<a name="l00364"></a>00364     );
<a name="l00365"></a>00365     boost::cmatch results;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="keywordflow">if</span> ( boost::regex_match( desc, results,  descriptionRegex ) ) {
<a name="l00368"></a>00368         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;repetitionTime&quot;</span> ) = util::Value&lt;uint16_t&gt;( results.str( 1 ) );
<a name="l00369"></a>00369         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;echoTime&quot;</span> ) = util::Value&lt;uint16_t&gt;( results.str( 2 ) );
<a name="l00370"></a>00370         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;flipAngle&quot;</span> ) = util::Value&lt;uint16_t&gt;( results.str( 3 ) );
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="keyword">const</span> util::Value&lt;int&gt; day = results.str( 4 ), month = results.str( 5 ), year = results.str( 6 );
<a name="l00373"></a>00373         <span class="keyword">const</span> util::Value&lt;uint8_t&gt; hours = boost::lexical_cast&lt;uint8_t&gt;( results.str( 7 ) ), minutes = boost::lexical_cast&lt;uint8_t&gt;( results.str( 8 ) ), seconds = boost::lexical_cast&lt;uint8_t&gt;( results.str( 9 ) );
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         boost::posix_time::ptime sequenceStart = boost::posix_time::ptime(
<a name="l00376"></a>00376             boost::gregorian::date( ( <span class="keywordtype">int</span> )year, ( <span class="keywordtype">int</span> )month, ( <span class="keywordtype">int</span> )day ),
<a name="l00377"></a>00377             boost::posix_time::time_duration( hours, minutes, seconds )
<a name="l00378"></a>00378         );
<a name="l00379"></a>00379         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;boost::posix_time::ptime&gt;( <span class="stringliteral">&quot;sequenceStart&quot;</span>, sequenceStart );
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00382"></a>00382                 &lt;&lt; <span class="stringliteral">&quot;Using Tr=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;repetitionTime&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot;, Te=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;echoTime&quot;</span> )
<a name="l00383"></a>00383         &lt;&lt; <span class="stringliteral">&quot;, flipAngle=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;flipAngle&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; and sequenceStart=&quot;</span> &lt;&lt; props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;sequenceStart&quot;</span> )
<a name="l00384"></a>00384         &lt;&lt; <span class="stringliteral">&quot; from SPM8 description.&quot;</span>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00387"></a>00387     } <span class="keywordflow">else</span>
<a name="l00388"></a>00388         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 <span class="keywordtype">void</span> ImageFormat_NiftiSa::storeHeader( <span class="keyword">const</span> util::PropertyMap &amp;props, _internal::nifti_1_header *head )
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392     <span class="keywordtype">bool</span> saved = <span class="keyword">false</span>;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="comment">// implicit stuff</span>
<a name="l00395"></a>00395     head-&gt;intent_code = 0;
<a name="l00396"></a>00396     head-&gt;slice_start = 0;
<a name="l00397"></a>00397     head-&gt;slice_end = head-&gt;dim[3];
<a name="l00398"></a>00398     head-&gt;scl_slope = 1;
<a name="l00399"></a>00399     head-&gt;scl_inter = 0;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">//in isis length is allways mm and time duration is allways msecs</span>
<a name="l00402"></a>00402     head-&gt;xyzt_units = <a class="code" href="imageFormat__nifti__sa_8hpp.html#ae37d3c19fa7561f6ef662bc27a4af5d4">NIFTI_UNITS_MM</a> | <a class="code" href="imageFormat__nifti__sa_8hpp.html#a3a890f2c798b2aa7853135e4c9b03113">NIFTI_UNITS_MSEC</a>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     head-&gt;dim_info = 1 | ( 2 &lt;&lt; 2 ) | ( 3 &lt;&lt; 4 ); <span class="comment">//readDim=1 phaseDim=2 sliceDim=3</span>
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="comment">//store description if there is one</span>
<a name="l00407"></a>00407     <span class="keywordflow">if</span>( props.hasProperty( <span class="stringliteral">&quot;sequenceDescription&quot;</span> ) )
<a name="l00408"></a>00408         strncpy( head-&gt;descrip, props.getPropertyAs&lt;std::string&gt;( <span class="stringliteral">&quot;sequenceDescription&quot;</span> ).c_str(), 80 );
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="comment">// store niftis original sform if its there</span>
<a name="l00411"></a>00411     <span class="keywordflow">if</span>( props.hasProperty( <span class="stringliteral">&quot;nifti/sform_code&quot;</span> ) ) {
<a name="l00412"></a>00412         head-&gt;sform_code = props.getPropertyAs&lt;util::Selection&gt;( <span class="stringliteral">&quot;nifti/sform_code&quot;</span> );
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         <span class="keywordflow">if</span>( props.hasProperty( <span class="stringliteral">&quot;nifti/srow_x&quot;</span> ) &amp;&amp; props.hasProperty( <span class="stringliteral">&quot;nifti/srow_y&quot;</span> ) &amp;&amp; props.hasProperty( <span class="stringliteral">&quot;nifti/srow_z&quot;</span> ) ) {
<a name="l00415"></a>00415             props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_x&quot;</span> ).copyTo( head-&gt;srow_x );
<a name="l00416"></a>00416             props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_y&quot;</span> ).copyTo( head-&gt;srow_y );
<a name="l00417"></a>00417             props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_z&quot;</span> ).copyTo( head-&gt;srow_z );
<a name="l00418"></a>00418         } <span class="keywordflow">else</span>
<a name="l00419"></a>00419             storeSForm( props, head );
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         saved = <span class="keyword">true</span>;
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="comment">// store niftis original qform if its there</span>
<a name="l00425"></a>00425     <span class="keywordflow">if</span>( props.hasProperty( <span class="stringliteral">&quot;nifti/qform_code&quot;</span> ) ) {
<a name="l00426"></a>00426         head-&gt;qform_code = props.getPropertyAs&lt;util::Selection&gt;( <span class="stringliteral">&quot;nifti/qform_code&quot;</span> );
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="keywordflow">if</span>( props.hasProperty( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span> ) &amp;&amp; props.hasProperty( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span> ) &amp;&amp; props.hasProperty( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span> ) &amp;&amp;
<a name="l00429"></a>00429         props.hasProperty( <span class="stringliteral">&quot;nifti/qoffset&quot;</span> ) &amp;&amp; props.hasProperty( <span class="stringliteral">&quot;nifti/qfac&quot;</span> )
<a name="l00430"></a>00430           ) {
<a name="l00431"></a>00431             <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a> offset = props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/qoffset&quot;</span> );
<a name="l00432"></a>00432             head-&gt;quatern_b = props.getPropertyAs&lt;<span class="keywordtype">float</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span> );
<a name="l00433"></a>00433             head-&gt;quatern_c = props.getPropertyAs&lt;<span class="keywordtype">float</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span> );
<a name="l00434"></a>00434             head-&gt;quatern_d = props.getPropertyAs&lt;<span class="keywordtype">float</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span> );
<a name="l00435"></a>00435             head-&gt;pixdim[0] = props.getPropertyAs&lt;<span class="keywordtype">float</span>&gt;( <span class="stringliteral">&quot;nifti/qfac&quot;</span> );
<a name="l00436"></a>00436             head-&gt;qoffset_x = offset[0];
<a name="l00437"></a>00437             head-&gt;qoffset_y = offset[1];
<a name="l00438"></a>00438             head-&gt;qoffset_z = offset[2];
<a name="l00439"></a>00439             saved = <span class="keyword">true</span>;
<a name="l00440"></a>00440         } <span class="keywordflow">else</span>
<a name="l00441"></a>00441             saved = storeQForm( props, head );
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="comment">//store current orientation (may override values set above)</span>
<a name="l00445"></a>00445     <span class="keywordflow">if</span>( !saved &amp;&amp; !storeQForm( props, head ) ) <span class="comment">//try to encode as quaternion</span>
<a name="l00446"></a>00446         storeSForm( props, head ); <span class="comment">//fall back to normal matrix</span>
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     strcpy( head-&gt;magic, <span class="stringliteral">&quot;n+1&quot;</span> );
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 std::list&lt; data::Chunk &gt; ImageFormat_NiftiSa::parseHeader( <span class="keyword">const</span> <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">isis::image_io::_internal::nifti_1_header</a> *head, <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">isis::data::Chunk</a> props )
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dims = head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0];
<a name="l00453"></a>00453     <span class="keywordtype">double</span> time_fac = 1;
<a name="l00454"></a>00454     <span class="keywordtype">double</span> size_fac = 1;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="keywordflow">switch</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> &amp; 0x07 ) {
<a name="l00457"></a>00457     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a58b8564584f3e2cda3bfb9daebdd28d5">NIFTI_UNITS_METER</a>:
<a name="l00458"></a>00458         size_fac = 1e3;
<a name="l00459"></a>00459         <span class="keywordflow">break</span>;
<a name="l00460"></a>00460     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a9ab584aac820e59dc2373581ee2c237e">NIFTI_UNITS_MICRON</a>:
<a name="l00461"></a>00461         size_fac = 1e-3;
<a name="l00462"></a>00462         <span class="keywordflow">break</span>;
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="keywordflow">switch</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ad5e57bc98baab2d0a6209086192bcaf6">xyzt_units</a> &amp; 0x38 ) {
<a name="l00466"></a>00466     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#ae1126a70acd21a99d7748c7ee9f877a8">NIFTI_UNITS_SEC</a>:
<a name="l00467"></a>00467         time_fac = 1e3;
<a name="l00468"></a>00468         <span class="keywordflow">break</span>;
<a name="l00469"></a>00469     <span class="keywordflow">case</span> <a class="code" href="imageFormat__nifti__sa_8hpp.html#a17714a9f67cbf27371ee9dda4a046942">NIFTI_UNITS_USEC</a>:
<a name="l00470"></a>00470         time_fac = 1e-3;
<a name="l00471"></a>00471         <span class="keywordflow">break</span>;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;uint16_t&gt;( <span class="stringliteral">&quot;sequenceNumber&quot;</span>, 0 );
<a name="l00476"></a>00476     props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;std::string&gt;( <span class="stringliteral">&quot;sequenceDescription&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a> );
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> ) { <span class="comment">// get srow if sform_code&gt;0</span>
<a name="l00479"></a>00479         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/sform_code&quot;</span>, formCode )-&gt;castTo&lt;util::Selection&gt;().<span class="keyword">set</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> );
<a name="l00480"></a>00480         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_x&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;().copyFrom( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a> + 4 );;
<a name="l00481"></a>00481         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_y&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;().copyFrom( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a> + 4 );;
<a name="l00482"></a>00482         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/srow_z&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>() )-&gt;castTo&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;().copyFrom( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a> + 4 );;
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> ) { <span class="comment">// get the quaternion if qform_code&gt;0</span>
<a name="l00486"></a>00486         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qform_code&quot;</span>, formCode )-&gt;castTo&lt;util::Selection&gt;().<span class="keyword">set</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> );
<a name="l00487"></a>00487         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">quatern_b</a> );
<a name="l00488"></a>00488         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">quatern_c</a> );
<a name="l00489"></a>00489         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">quatern_d</a> );
<a name="l00490"></a>00490         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qoffset&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">qoffset_x</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">qoffset_y</a>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">qoffset_z</a>, 0 ) );
<a name="l00491"></a>00491         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>( <span class="stringliteral">&quot;nifti/qfac&quot;</span>, ( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[0] == -1 ) ? -1 : 1 );
<a name="l00492"></a>00492 
<a name="l00493"></a>00493         <span class="comment">// voxel size</span>
<a name="l00494"></a>00494         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a> v_size;
<a name="l00495"></a>00495         v_size.copyFrom( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a> + 1, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a> + std::min&lt;unsigned short&gt;( dims, 3 ) + 1 );
<a name="l00496"></a>00496         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/pixdim&quot;</span>, v_size * size_fac );
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> ) { <span class="comment">// if sform_code is set, use that regardless of qform</span>
<a name="l00500"></a>00500         useSForm( props );
<a name="l00501"></a>00501     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> ) { <span class="comment">// if qform_code is set, but no sform use that (thats the &quot;normal&quot; case)</span>
<a name="l00502"></a>00502         useQForm( props );
<a name="l00503"></a>00503     } <span class="keywordflow">else</span> {
<a name="l00504"></a>00504         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> ) &lt;&lt; <span class="stringliteral">&quot;Neither sform_code nor qform_code are set, using identity matrix for geometry&quot;</span>;
<a name="l00505"></a>00505         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span>,    nifti2isis.getRow( 0 ) ); <span class="comment">// we use the transformation from nifti to isis as unity</span>
<a name="l00506"></a>00506         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span>, nifti2isis.getRow( 1 ) ); <span class="comment">// because the image will very likely be in nifti space</span>
<a name="l00507"></a>00507         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span>,  nifti2isis.getRow( 2 ) );
<a name="l00508"></a>00508         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[1], head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[2], head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[3] ) );
<a name="l00509"></a>00509         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span>, <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 0, 0, 0 ) );
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="comment">// set space unit factors</span>
<a name="l00513"></a>00513     props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;voxelSize&quot;</span> )-&gt;castTo&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;() *= size_fac;
<a name="l00514"></a>00514     props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#a4c656dc09e8b6b41f96dd9e396ac20df" title="Access the property referenced by the path-key.">propertyValue</a>( <span class="stringliteral">&quot;indexOrigin&quot;</span> )-&gt;castTo&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;() *= size_fac;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <span class="comment">// Tr</span>
<a name="l00517"></a>00517     <span class="keywordflow">if</span>( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[dims] != 0 ) <span class="comment">// if pixdim is given for the uppermost dim, assume its repetitionTime</span>
<a name="l00518"></a>00518         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;uint16_t&gt;( <span class="stringliteral">&quot;repetitionTime&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[dims]*time_fac );
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="comment">// sequenceDescription</span>
<a name="l00521"></a>00521     <span class="keywordflow">if</span>( !parseDescripForSPM( props, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a> ) ) <span class="comment">// if descrip dos not hold Te,Tr and stuff (SPM dialect)</span>
<a name="l00522"></a>00522         props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#adee60064ebd5e24f31c31dcf8750eb29" title="Set the given property to a given value/type.">setPropertyAs</a>&lt;std::string&gt;( <span class="stringliteral">&quot;sequenceDescription&quot;</span>, head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a> ); <span class="comment">// use it the usual way</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="comment">// TODO: at the moment scaling not supported due to data type changes</span>
<a name="l00525"></a>00525     <span class="keywordflow">if</span> ( !head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">scl_slope</a> == 0 &amp;&amp; !( head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">scl_slope</a> == 1 || head-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a570f6c8dc72f63af277406d0a84ca604">scl_inter</a> == 0 ) ) {
<a name="l00526"></a>00526         <span class="comment">//          throwGenericError( std::string( &quot;Scaling is not supported at the moment. Scale Factor: &quot; ) + util::Value&lt;float&gt;( scale ).toString() );</span>
<a name="l00527"></a>00527         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Scaling is not supported at the moment.&quot;</span>;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">return</span> parseSliceOrdering( head, props );
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 std::string <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fc2a1f94333c4a40f1034319fa769aa">ImageFormat_NiftiSa::getName</a>()<span class="keyword">const </span>{<span class="keywordflow">return</span> <span class="stringliteral">&quot;Nifti standalone&quot;</span>;}
<a name="l00534"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fc2a1f94333c4a40f1034319fa769aa">00534</a> 
<a name="l00535"></a>00535 <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">isis::data::ValuePtr&lt; bool &gt;</a> ImageFormat_NiftiSa::bitRead( <a class="code" href="classisis_1_1data_1_1ValuePtr.html">data::ValuePtr&lt; uint8_t &gt;</a> src, <span class="keywordtype">size_t</span> size )
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     assert( size );
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     <span class="keywordflow">if</span>( src.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>() * 8 &lt; size ) {
<a name="l00540"></a>00540         std::string err( <span class="stringliteral">&quot;unexpected end of file (missing &quot;</span> );
<a name="l00541"></a>00541         err += boost::lexical_cast&lt;std::string&gt;( size - src.<a class="code" href="classisis_1_1data_1_1__internal_1_1ValuePtrBase.html#a8dbcc5e2ef0688856a04ecdb00ab2a31">getLength</a>() * 8 ) + <span class="stringliteral">&quot; bytes)&quot;</span>;
<a name="l00542"></a>00542         <a class="code" href="classisis_1_1image__io_1_1FileFormat.html#afa895e4283f39c344f5daf4796f2d877">throwGenericError</a>( err );
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">isis::data::ValuePtr&lt; bool &gt;</a> ret( size );
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> i = 0; i &lt; size; i++ ) {
<a name="l00548"></a>00548         <span class="keyword">const</span> <span class="keywordtype">size_t</span> byte = i / 8;
<a name="l00549"></a>00549         <span class="keyword">const</span> uint8_t mask = 128 &gt;&gt; ( i % 8 );
<a name="l00550"></a>00550         ret[i] = mask &amp; src[byte];
<a name="l00551"></a>00551     }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">return</span> ret;
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="keywordtype">bool</span> ImageFormat_NiftiSa::checkSwapEndian ( <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *header )
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558 <span class="preprocessor">#define DO_SWAP(VAR) VAR=data::endianSwap(VAR)</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="preprocessor">#define DO_SWAPA(VAR,SIZE) data::endianSwapArray(VAR,VAR+SIZE,VAR);</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span>
<a name="l00561"></a>00561     <span class="keywordflow">if</span>( <a class="code" href="namespaceisis_1_1data.html#a649709edd7e060b1335e840f5a1ba639">data::endianSwap</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a> ) == 348 ) { <span class="comment">// ok we have to swap the endianess</span>
<a name="l00562"></a>00562         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a> );
<a name="l00563"></a>00563         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a90a45f4754ba3d8640835eb8379fd225">extents</a> );
<a name="l00564"></a>00564         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a7e45844737abeccbbcd88a661a716936">session_error</a> );
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adeb6c079ba9e4687e3099af19850ee9f">intent_p1</a> );
<a name="l00567"></a>00567         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b8100de819afb3e0ec28e7b2b987622">intent_p2</a> );
<a name="l00568"></a>00568         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aef7df04bb20707637d5826898b6766bd">intent_p3</a> );
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">intent_code</a> );
<a name="l00571"></a>00571         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> );
<a name="l00572"></a>00572         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a> );
<a name="l00573"></a>00573         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a792a1bb6fc1eba891ecdcc696a6c6dd9">slice_start</a> );
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> );
<a name="l00576"></a>00576         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a58b3a227453852aa53cfe52992eee8af">scl_slope</a> );
<a name="l00577"></a>00577         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a570f6c8dc72f63af277406d0a84ca604">scl_inter</a> );
<a name="l00578"></a>00578         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa94982ee96bb81abd1d9165aedc6d75a">slice_end</a> );
<a name="l00579"></a>00579 
<a name="l00580"></a>00580         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">cal_max</a> );
<a name="l00581"></a>00581         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">cal_min</a> );
<a name="l00582"></a>00582         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> );
<a name="l00583"></a>00583         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a6146d9ec1f864ccbf221e4cc9976baf0">toffset</a> );
<a name="l00584"></a>00584         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a08826cdf9961a168358836a0a39c9e4e">glmax</a> );
<a name="l00585"></a>00585         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ae9c0b2b09667ec96512db03acb1956af">glmin</a> );
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aaaf368fb759269cd380f1c3a7da813cf">qform_code</a> );
<a name="l00588"></a>00588         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a216df424333a187827636cfa5baf6dcc">sform_code</a> );
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abfc9de09b2fce7e27aa1e090892cc832">quatern_b</a> );
<a name="l00591"></a>00591         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8a18b72d121e2d1563fd058e6d087e24">quatern_c</a> );
<a name="l00592"></a>00592         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8b78d87860e7e30fa37d2f37f299ce09">quatern_d</a> );
<a name="l00593"></a>00593         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#aa5e06f0b089155603aef5760ca3d5413">qoffset_x</a> );
<a name="l00594"></a>00594         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70ac82f3072d88f52fab3a5805f379d8">qoffset_y</a> );
<a name="l00595"></a>00595         <a class="code" href="imageFormat__nifti__sa_8cpp.html#abfa6441a53e5a90a582b3b26204e8ca0">DO_SWAP</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a444c21c92951cfdaa0d95eb28fea719c">qoffset_z</a> );
<a name="l00596"></a>00596 
<a name="l00597"></a>00597         <a class="code" href="imageFormat__nifti__sa_8cpp.html#a537b79bf701277f9f7b581bc2c0f3587">DO_SWAPA</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>, 8 );
<a name="l00598"></a>00598         <a class="code" href="imageFormat__nifti__sa_8cpp.html#a537b79bf701277f9f7b581bc2c0f3587">DO_SWAPA</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>, 8 );
<a name="l00599"></a>00599         <a class="code" href="imageFormat__nifti__sa_8cpp.html#a537b79bf701277f9f7b581bc2c0f3587">DO_SWAPA</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a48b2adc785d21c25a8f92cfc05defa96">srow_x</a>, 4 );
<a name="l00600"></a>00600         <a class="code" href="imageFormat__nifti__sa_8cpp.html#a537b79bf701277f9f7b581bc2c0f3587">DO_SWAPA</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#adebf610456cb80696283db3fcd8ed866">srow_y</a>, 4 );
<a name="l00601"></a>00601         <a class="code" href="imageFormat__nifti__sa_8cpp.html#a537b79bf701277f9f7b581bc2c0f3587">DO_SWAPA</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a072da827be70185fb810fef5b3922bf3">srow_z</a>, 4 );
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00604"></a>00604     } <span class="keywordflow">else</span>
<a name="l00605"></a>00605         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="preprocessor">#undef DO_SWAP</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span><span class="preprocessor">#undef DO_SWAPA</span>
<a name="l00609"></a>00609 <span class="preprocessor"></span>}
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 
<a name="l00612"></a>00612 <span class="keywordtype">int</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#afaa8baba07d100ecf3816a22d9c9976c" title="Load data into the given chunk list.">ImageFormat_NiftiSa::load</a> ( std::list&lt;data::Chunk&gt; &amp;chunks, <span class="keyword">const</span> std::string &amp;filename, <span class="keyword">const</span> std::string &amp;dialect )  <span class="keywordflow">throw</span>( std::runtime_error &amp; )
<a name="l00613"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#afaa8baba07d100ecf3816a22d9c9976c">00613</a> {
<a name="l00614"></a>00614     <a class="code" href="classisis_1_1data_1_1FilePtr.html" title="Class to map files into memory.">data::FilePtr</a> mfile( filename );
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">if</span>( !mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#aef7b8afaf8f6f390c77fb1f9c76876d8">good</a>() ) {
<a name="l00617"></a>00617         <span class="keywordflow">if</span>( errno ) {
<a name="l00618"></a>00618             throwSystemError( errno, filename + <span class="stringliteral">&quot; could not be opened&quot;</span> );
<a name="l00619"></a>00619             errno = 0;
<a name="l00620"></a>00620         } <span class="keywordflow">else</span>
<a name="l00621"></a>00621             throwGenericError( filename + <span class="stringliteral">&quot; could not be opened&quot;</span> );
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">//get the header - we use it directly from the file</span>
<a name="l00625"></a>00625     <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *header = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *<span class="keyword">&gt;</span>( &amp;mfile[0] );
<a name="l00626"></a>00626     <span class="keyword">const</span> <span class="keywordtype">bool</span> swap_endian = checkSwapEndian( header );
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">if</span>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe096ca0f8401e8d5ec2e66fce8863eb">intent_code</a> != 0 ) {
<a name="l00629"></a>00629         throwGenericError( std::string( <span class="stringliteral">&quot;only intent_code==0 is supportet&quot;</span> ) );
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="keywordflow">if</span>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a> &lt; 348 ) {
<a name="l00633"></a>00633         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> ) &lt;&lt; <span class="stringliteral">&quot;sizeof_hdr of the file (&quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> &lt;&lt; <span class="stringliteral">&quot;) is invalid, assuming 348&quot;</span>;
<a name="l00634"></a>00634         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a63cfcc859e72f446279623cbc3a6600c">sizeof_hdr</a> = 348;
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="keywordflow">if</span>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> &lt; 352 ) {
<a name="l00638"></a>00638         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> ) &lt;&lt; <span class="stringliteral">&quot;vox_offset of the file (&quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> &lt;&lt; <span class="stringliteral">&quot;) is invalid, assuming 352&quot;</span>;
<a name="l00639"></a>00639         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> = 352;
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">if</span>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> &lt; 0 ) {
<a name="l00643"></a>00643         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> ) &lt;&lt; <span class="stringliteral">&quot;ignoring invalid slice duration (&quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00644"></a>00644         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> = 0;
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <span class="comment">//set up the size - copy dim[0] values from dim[1]..dim[dim[0]]</span>
<a name="l00648"></a>00648     <a class="code" href="classisis_1_1util_1_1vector4.html">util::vector4&lt;size_t&gt;</a> size;
<a name="l00649"></a>00649     size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#af94746a0cc9eb0e48a2a71da0e3a56c6" title="Set all elements to a value.">fill</a>( 1 );
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#a00afc94aa6452abf889ffddc4ebb76fd" title="copy the elements to somthing designed after the output iterator model">copyFrom</a>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a> + 1, header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a> + 1 + header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a292e01c9aacf42bcec39e6c4eb0852e7">dim</a>[0] );
<a name="l00652"></a>00652     <a class="code" href="classisis_1_1util_1_1__internal_1_1ValueReference.html" title="Base class to store and handle references to Value and ValuePtr objects.">data::ValuePtrReference</a> data_src;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="keywordflow">if</span>( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> == <a class="code" href="imageFormat__nifti__sa_8hpp.html#a24d9052ecd00b9ad2b2f3113323ecd83">NIFTI_TYPE_BINARY</a> ) { <span class="comment">// image is binary encoded - needs special decoding</span>
<a name="l00655"></a>00655         data_src = bitRead( mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#acefaa068f3f5932d109009560912b318" title="Get a ValuePtr representing the data in the file.">at</a>&lt;uint8_t&gt;( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a> ), size.<a class="code" href="classisis_1_1util_1_1FixedVector.html#aa1fd806e4a644673d3ac867b574498b9" title="Compute the product of all elements.">product</a>() );
<a name="l00656"></a>00656     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="namespaceisis_1_1util.html#a85956c20207215d2b77e4c0935e494d5">util::istring</a>( <span class="stringliteral">&quot;fsl&quot;</span> ) == dialect.c_str() &amp;&amp; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> == <a class="code" href="imageFormat__nifti__sa_8hpp.html#a1ef0dc17948c65b6a7311fe96ddfc441">NIFTI_TYPE_UINT8</a> &amp;&amp; size[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] == 3 ) { <span class="comment">//if its fsl-three-volume-color copy the volumes</span>
<a name="l00657"></a>00657         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad35fd8a1a402fc01ce52911ebd7a51e4">notice</a> ) &lt;&lt; <span class="stringliteral">&quot;The image has 3 timesteps and its type is UINT8, assuming it is an fsl color image.&quot;</span>;
<a name="l00658"></a>00658         <span class="keyword">const</span> <span class="keywordtype">size_t</span> volume = size.product() / 3;
<a name="l00659"></a>00659         <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;util::color24&gt;</a> buff( volume );
<a name="l00660"></a>00660         <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1ValuePtr.html">data::ValuePtr&lt;uint8_t&gt;</a> src = mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#acefaa068f3f5932d109009560912b318" title="Get a ValuePtr representing the data in the file.">at</a>&lt;uint8_t&gt;( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>, volume * 3 );
<a name="l00661"></a>00661         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Mapping nifti image as FSL RBG set of 3*&quot;</span> &lt;&lt; volume &lt;&lt; <span class="stringliteral">&quot; elements&quot;</span>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> v = 0; v &lt; volume; v++ ) {
<a name="l00664"></a>00664             buff[v].r = src[v];
<a name="l00665"></a>00665             buff[v].g = src[v + volume];
<a name="l00666"></a>00666             buff[v].b = src[v + volume * 2];
<a name="l00667"></a>00667         }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         data_src = buff;
<a name="l00670"></a>00670         size[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] = 1;
<a name="l00671"></a>00671     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="namespaceisis_1_1util.html#a85956c20207215d2b77e4c0935e494d5">util::istring</a>( <span class="stringliteral">&quot;fsl&quot;</span> ) == dialect.c_str() &amp;&amp; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> == <a class="code" href="imageFormat__nifti__sa_8hpp.html#a8220ccec425b9387abf3d2b71ac0be7e">NIFTI_TYPE_FLOAT32</a> &amp;&amp; size[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] == 3 ) { <span class="comment">//if its fsl-three-volume-vector copy the volumes</span>
<a name="l00672"></a>00672         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad35fd8a1a402fc01ce52911ebd7a51e4">notice</a> ) &lt;&lt; <span class="stringliteral">&quot;The image has 3 timesteps and its type is FLOAT32, assuming it is an fsl vector image.&quot;</span>;
<a name="l00673"></a>00673         <span class="keyword">const</span> <span class="keywordtype">size_t</span> volume = size.product() / 3;
<a name="l00674"></a>00674         <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;util::fvector4&gt;</a> buff( volume );
<a name="l00675"></a>00675         <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;float&gt;</a> src = mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#acefaa068f3f5932d109009560912b318" title="Get a ValuePtr representing the data in the file.">at</a>&lt;<span class="keywordtype">float</span>&gt;( header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>, size.product(), swap_endian );
<a name="l00676"></a>00676 
<a name="l00677"></a>00677         <span class="keywordflow">for</span>( <span class="keywordtype">size_t</span> v = 0; v &lt; volume; v++ ) {
<a name="l00678"></a>00678             buff[v][0] = src[v];
<a name="l00679"></a>00679             buff[v][1] = src[v + volume];
<a name="l00680"></a>00680             buff[v][2] = src[v + volume * 2];
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683         data_src = buff;
<a name="l00684"></a>00684         size[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] = 1;
<a name="l00685"></a>00685     } <span class="keywordflow">else</span> {
<a name="l00686"></a>00686         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> type = nifti_type2isis_type[header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a>];
<a name="l00687"></a>00687 
<a name="l00688"></a>00688         <span class="keywordflow">if</span>( type ) {
<a name="l00689"></a>00689             data_src = mfile.<a class="code" href="classisis_1_1data_1_1FilePtr.html#a7301c37340f98591f769c26b796d81f1" title="Get a ValuePtrReference to a ValuePtr of the requested type.">atByID</a>( type, header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#abe2f2da2e3aaad7b975086c6e295234f">vox_offset</a>, size.product(), swap_endian );
<a name="l00690"></a>00690 
<a name="l00691"></a>00691             <span class="keywordflow">if</span>( swap_endian ) {
<a name="l00692"></a>00692                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00693"></a>00693                         &lt;&lt; <span class="stringliteral">&quot;Opened nifti image as endianess swapped &quot;</span> &lt;&lt; data_src-&gt;getTypeName() &lt;&lt; <span class="stringliteral">&quot; of &quot;</span> &lt;&lt; data_src-&gt;getLength()
<a name="l00694"></a>00694                 &lt;&lt; <span class="stringliteral">&quot; elements (&quot;</span> &lt;&lt; data_src-&gt;bytesPerElem()*data_src-&gt;getLength() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00695"></a>00695             } <span class="keywordflow">else</span> {
<a name="l00696"></a>00696                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00697"></a>00697                         &lt;&lt; <span class="stringliteral">&quot;Mapped nifti image natively as &quot;</span> &lt;&lt; data_src-&gt;getTypeName() &lt;&lt; <span class="stringliteral">&quot; of &quot;</span> &lt;&lt; data_src-&gt;getLength()
<a name="l00698"></a>00698                 &lt;&lt; <span class="stringliteral">&quot; elements (&quot;</span> &lt;&lt; data_src-&gt;bytesPerElem()*data_src-&gt;getLength() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00699"></a>00699             }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701             <a class="code" href="log_8hpp.html#a977f6c27373576d6ffe1523fc2afb8b6">LOG_IF</a>( ( <span class="keywordtype">size_t</span> )header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a> != data_src-&gt;bytesPerElem() * 8, <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a5e3b72b2efcd89afa9487c776fb12d19">warning</a> )
<a name="l00702"></a>00702                     &lt;&lt; <span class="stringliteral">&quot;nifti field bitpix does not fit the bytesize of the given datatype (&quot;</span> &lt;&lt; data_src-&gt;getTypeName() &lt;&lt; <span class="stringliteral">&quot;/&quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a70658bb32aebd2f40959d524fc0c7c4a">bitpix</a> &lt;&lt;  <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         } <span class="keywordflow">else</span> {
<a name="l00705"></a>00705             <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Sorry, the nifti datatype &quot;</span> &lt;&lt; header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> &lt;&lt; <span class="stringliteral">&quot; is not (yet) supported&quot;</span>;
<a name="l00706"></a>00706             throwGenericError( <span class="stringliteral">&quot;unsupported datatype&quot;</span> );
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     std::list&lt;data::Chunk&gt; newChunks = parseHeader( header, <a class="code" href="classisis_1_1data_1_1Chunk.html" title="Main class for four-dimensional random-access data blocks.">data::Chunk</a>( data_src, size[0], size[1], size[2], size[3] ) );
<a name="l00711"></a>00711     chunks.insert( chunks.begin(), newChunks.begin(), newChunks.end() );
<a name="l00712"></a>00712     <span class="keywordflow">return</span> newChunks.size();
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 std::auto_ptr&lt; _internal::WriteOp &gt; ImageFormat_NiftiSa::getWriteOp( <span class="keyword">const</span> <a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">isis::data::Image</a> &amp;src, <a class="code" href="namespaceisis_1_1util.html#a85956c20207215d2b77e4c0935e494d5">isis::util::istring</a> dialect )
<a name="l00716"></a>00716 {
<a name="l00717"></a>00717     <span class="keyword">const</span> <span class="keywordtype">size_t</span> bpv = src.<a class="code" href="classisis_1_1data_1_1Image.html#a873a72def2728e8cfc060ee8c6ac6bd3" title="get the voxelsize (in bytes) for the major type in the image">getBytesPerVoxel</a>() * 8;
<a name="l00718"></a>00718     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> target_id = src.<a class="code" href="classisis_1_1data_1_1Image.html#a601eaac6eedf7eaf6fdb6c31b1e8765d" title="Get the type of the chunk with &amp;quot;biggest&amp;quot; type.">getMajorTypeID</a>(); <span class="comment">//default to major type of the image</span>
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="comment">//bitmap is not supportet by spm and fsl</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span>( target_id == <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;bool&gt;::staticID</a> ) {
<a name="l00722"></a>00722         <span class="keywordflow">if</span>( dialect == <span class="stringliteral">&quot;fsl&quot;</span> || dialect == <span class="stringliteral">&quot;spm&quot;</span> ) {
<a name="l00723"></a>00723             target_id = typeFallBack&lt;bool, uint8_t&gt;( dialect.c_str() );<span class="comment">// fall back to uint8_t and use normal writer for that</span>
<a name="l00724"></a>00724         } <span class="keywordflow">else</span> {
<a name="l00725"></a>00725             <span class="keywordflow">return</span> std::auto_ptr&lt;_internal::WriteOp&gt;( <span class="keyword">new</span> _internal::BitWriteOp( src ) ); <span class="comment">// use special writer for bit</span>
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="comment">// fsl cannot deal with some types</span>
<a name="l00730"></a>00730     <span class="keywordflow">if</span>( dialect == <span class="stringliteral">&quot;fsl&quot;</span> ) {
<a name="l00731"></a>00731         <span class="keywordflow">switch</span>( target_id ) {
<a name="l00732"></a>00732         <span class="keywordflow">case</span> data::ValuePtr&lt;uint16_t&gt;::staticID:
<a name="l00733"></a>00733             target_id = typeFallBack&lt;uint16_t, int16_t&gt;( <span class="stringliteral">&quot;fsl&quot;</span> );
<a name="l00734"></a>00734             <span class="keywordflow">break</span>;
<a name="l00735"></a>00735         <span class="keywordflow">case</span> data::ValuePtr&lt;uint32_t&gt;::staticID:
<a name="l00736"></a>00736             target_id = typeFallBack&lt;uint32_t, int32_t&gt;( <span class="stringliteral">&quot;fsl&quot;</span> );
<a name="l00737"></a>00737             <span class="keywordflow">break</span>;
<a name="l00738"></a>00738         <span class="keywordflow">case</span> data::ValuePtr&lt;util::color24&gt;::staticID:
<a name="l00739"></a>00739 
<a name="l00740"></a>00740             <span class="keywordflow">if</span>( src.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#ad5e59bb1c93f616a20be4c5ed5e818ff" title="get amount of relevant dimensions (last dim with size&amp;gt;1) e.g.">getRelevantDims</a>() &gt; 3 ) {
<a name="l00741"></a>00741                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Cannot store color image of size &quot;</span> &lt;&lt; src.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a5987df3c819b04abd031e0049a87f3e7" title="generates a string representing the size">getSizeAsString</a>() &lt;&lt; <span class="stringliteral">&quot; using fsl dialect (4th dim is needed for the colors)&quot;</span>;
<a name="l00742"></a>00742                 <a class="code" href="classisis_1_1image__io_1_1FileFormat.html#afa895e4283f39c344f5daf4796f2d877">throwGenericError</a>( <span class="stringliteral">&quot;unsupported datatype&quot;</span> );
<a name="l00743"></a>00743             } <span class="keywordflow">else</span> {
<a name="l00744"></a>00744                 <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; data::ValuePtr&lt;util::color24&gt;::staticName() &lt;&lt;  <span class="stringliteral">&quot; is not supported by fsl falling back to color encoded in 4th dimension&quot;</span>;
<a name="l00745"></a>00745                 <span class="keywordflow">return</span> std::auto_ptr&lt;_internal::WriteOp&gt;( <span class="keyword">new</span> _internal::FslRgbWriteOp( src ) );
<a name="l00746"></a>00746             }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748             <span class="keywordflow">break</span>;
<a name="l00749"></a>00749         }
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="comment">// generic case (use generic scalar writer for the target_id)</span>
<a name="l00753"></a>00753     <span class="keywordflow">return</span> std::auto_ptr&lt;_internal::WriteOp&gt;( <span class="keyword">new</span> _internal::CommonWriteOp( src, target_id, bpv, ( dialect == <span class="stringliteral">&quot;spm&quot;</span> ) ) );
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="keywordtype">void</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fd192a16f8088bd3a2ce01b49933853" title="Write a single image to a file.">ImageFormat_NiftiSa::write</a>( <span class="keyword">const</span> data::Image &amp;image, <span class="keyword">const</span> std::string &amp;filename, <span class="keyword">const</span> std::string &amp;dialect )  <span class="keywordflow">throw</span>( std::runtime_error &amp; )
<a name="l00758"></a><a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html#a4fd192a16f8088bd3a2ce01b49933853">00758</a> {
<a name="l00759"></a>00759     <span class="keyword">const</span> <span class="keywordtype">size_t</span> voxel_offset = 352; <span class="comment">// must be &gt;=352 (and multiple of 16)  (http://nifti.nimh.nih.gov/nifti-1/documentation/nifti1fields/nifti1fields_pages/vox_offset.html)</span>
<a name="l00760"></a>00760     std::auto_ptr&lt; _internal::WriteOp &gt; writer = getWriteOp( image, dialect.c_str() ); <span class="comment">// get a fitting writer for the datatype</span>
<a name="l00761"></a>00761     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nifti_id = isis_type2nifti_type[writer-&gt;getTypeId()]; <span class="comment">// get the nifti datatype corresponding to our datatype</span>
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="keywordflow">if</span>( nifti_id ) { <span class="comment">// there is a corresponding nifti datatype</span>
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <span class="comment">// open/map the new file</span>
<a name="l00766"></a>00766         <span class="keywordflow">if</span>( !writer-&gt;setOutput( filename, voxel_offset ) ) {
<a name="l00767"></a>00767             <span class="keywordflow">if</span>( errno ) {
<a name="l00768"></a>00768                 throwSystemError( errno, filename + <span class="stringliteral">&quot; could not be opened&quot;</span> );
<a name="l00769"></a>00769                 errno = 0;
<a name="l00770"></a>00770             } <span class="keywordflow">else</span>
<a name="l00771"></a>00771                 throwGenericError( filename + <span class="stringliteral">&quot; could not be opened&quot;</span> );
<a name="l00772"></a>00772         }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="comment">// get the first 348 bytes as header</span>
<a name="l00776"></a>00776         <a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html">_internal::nifti_1_header</a> *header = writer-&gt;getHeader();
<a name="l00777"></a>00777         header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ab9777762d3020a95497945e73e4d1682">datatype</a> = nifti_id;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779         guessSliceOrdering( image, header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a3589538dfdb21563399b497df9fe98cb">slice_code</a>, header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#ac4d162e3bf402ed3f2f1ea1beaa93c51">slice_duration</a> );
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="keywordflow">if</span>( image.<a class="code" href="classisis_1_1data_1_1Image.html#a601eaac6eedf7eaf6fdb6c31b1e8765d" title="Get the type of the chunk with &amp;quot;biggest&amp;quot; type.">getMajorTypeID</a>() == <a class="code" href="classisis_1_1data_1_1ValuePtr.html" title="Generic class for type (and length) - aware pointers.">data::ValuePtr&lt;util::color24&gt;::staticID</a> ) {
<a name="l00782"></a>00782             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">cal_min</a> = 0;
<a name="l00783"></a>00783             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">cal_max</a> = 255;
<a name="l00784"></a>00784         } <span class="keywordflow">else</span> {
<a name="l00785"></a>00785             <span class="keyword">const</span> std::pair&lt; float, float &gt; minmax = image.<a class="code" href="classisis_1_1data_1_1Image.html#ae4bef75405f6729ab6c81191dc23bfc0" title="Get the maximum and the minimum voxel value of the image.">getMinMaxAs</a>&lt;<span class="keywordtype">float</span>&gt;();
<a name="l00786"></a>00786             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a1e6db75da8c1efa31563c55fad205236">cal_min</a> = minmax.first;
<a name="l00787"></a>00787             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a0938bbc0ae034612149416ccdf2dcbd2">cal_max</a> = minmax.second;
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         storeHeader( image.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0 ), header ); <span class="comment">// store properties of the &quot;lowest&quot; chunk merged with the image&#39;s properties into the header</span>
<a name="l00791"></a>00791 
<a name="l00792"></a>00792         <span class="keywordflow">if</span>( image.<a class="code" href="classisis_1_1data_1_1__internal_1_1NDimensional.html#a498b4ebaa5ef654ebe41eacebe813e66" title="generates a FixedVector&amp;lt;DIMS&amp;gt; representing the size">getSizeAsVector</a>()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] &gt; 1 &amp;&amp; image.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ace197e0a37714072c4b8a9c9096018a1" title="check if property is available">hasProperty</a>( <span class="stringliteral">&quot;repetitionTime&quot;</span> ) )
<a name="l00793"></a>00793             header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#acb2780594d2926bd6cbad32d30d97ea7">pixdim</a>[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a> + 1] = image.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ae3f42731036b6f53afbdbb063e03d958" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<span class="keywordtype">float</span>&gt;( <span class="stringliteral">&quot;repetitionTime&quot;</span> );
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         <span class="keywordflow">if</span>( <a class="code" href="namespaceisis_1_1util.html#a85956c20207215d2b77e4c0935e494d5">util::istring</a>( dialect.c_str() ) == <span class="stringliteral">&quot;spm&quot;</span> ) { <span class="comment">// override &quot;normal&quot; description with the &quot;spm-description&quot;</span>
<a name="l00796"></a>00796             storeDescripForSPM( image.<a class="code" href="classisis_1_1data_1_1Image.html#afda7218833647cc6526950524775140d" title="Get the chunk that contains the voxel at the given coordinates.">getChunk</a>( 0, 0 ), header-&gt;<a class="code" href="structisis_1_1image__io_1_1__internal_1_1nifti__1__header.html#a8773dd7806d22927aba762e6a6449142">descrip</a> );
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         <span class="comment">// actually copy the data from each chunk of the image</span>
<a name="l00800"></a>00800         <span class="keyword">const_cast&lt;</span><a class="code" href="classisis_1_1data_1_1Image.html" title="Main class for generic 4D-images.">data::Image</a> &amp;<span class="keyword">&gt;</span>( image ).foreachChunk( *writer ); <span class="comment">// @todo we _do_ need a const version of foreachChunk/Voxel</span>
<a name="l00801"></a>00801     } <span class="keywordflow">else</span> {
<a name="l00802"></a>00802         <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#ad95ad94c644019674b1532c4a2ac05c8">Runtime</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82a41a0a4591faa6079940551ad22c43597">error</a> ) &lt;&lt; <span class="stringliteral">&quot;Sorry, the datatype &quot;</span> &lt;&lt; <a class="code" href="classisis_1_1util_1_1MSubject.html">util::MSubject</a>( image.<a class="code" href="classisis_1_1data_1_1Image.html#a6d5302c9e0de9fe8c97fbafa4a9e2d1e">getMajorTypeName</a>() ) &lt;&lt; <span class="stringliteral">&quot; is not supportet for nifti output&quot;</span>;
<a name="l00803"></a>00803         throwGenericError( <span class="stringliteral">&quot;unsupported datatype&quot;</span> );
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 
<a name="l00809"></a>00809 <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">util::Matrix4x4&lt;double&gt;</a> ImageFormat_NiftiSa::getNiftiMatrix( <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1PropertyMap.html" title="This class contains a mapping tree to store all kinds of properties (path/key : value) It&amp;#39;s also ...">util::PropertyMap</a> &amp;props )
<a name="l00810"></a>00810 {
<a name="l00811"></a>00811     <a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a> scale = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ae3f42731036b6f53afbdbb063e03d958" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span> ); <span class="comment">//used to put the scaling into the transformation</span>
<a name="l00812"></a>00812     <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a> offset = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ae3f42731036b6f53afbdbb063e03d958" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span> );
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <span class="keywordflow">if</span>( props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ace197e0a37714072c4b8a9c9096018a1" title="check if property is available">hasProperty</a>( <span class="stringliteral">&quot;voxelGap&quot;</span> ) ) {
<a name="l00815"></a>00815         <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a> gap = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ae3f42731036b6f53afbdbb063e03d958" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a>&gt;( <span class="stringliteral">&quot;voxelGap&quot;</span> );
<a name="l00816"></a>00816         scale += gap; <span class="comment">//nifti does not know about gaps, just add it to the voxel size</span>
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="comment">// the direction vectors should be normalized (says the isis-doc) but we get them in a higher precission than usual - so lets re-norm them</span>
<a name="l00820"></a>00820     <a class="code" href="classisis_1_1util_1_1vector4.html">util::dvector4</a> mat_rows[3];
<a name="l00821"></a>00821     <span class="keyword">const</span> <span class="keywordtype">char</span> *row_names[] = {<span class="stringliteral">&quot;rowVec&quot;</span>, <span class="stringliteral">&quot;columnVec&quot;</span>, <span class="stringliteral">&quot;sliceVec&quot;</span>};
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; 3; i++ ) {
<a name="l00824"></a>00824         mat_rows[i] = props.<a class="code" href="classisis_1_1util_1_1PropertyMap.html#ae3f42731036b6f53afbdbb063e03d958" title="Request a property via the given key in the given type.">getPropertyAs</a>&lt;<a class="code" href="namespaceisis_1_1util.html#a95fd2a2f3c43b5414665ac7640d45f85">util::dvector4</a>&gt;( row_names[i] );
<a name="l00825"></a>00825         mat_rows[i].<a class="code" href="classisis_1_1util_1_1FixedVector.html#adbe27fd269f3eab2107c85f3ee7a92fa" title="Norm the vector (make len()==1).">norm</a>();
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     util::Matrix4x4&lt;double&gt; image2isis = util::Matrix4x4&lt;double&gt;(
<a name="l00829"></a>00829         mat_rows[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a9f473e3b41b1b75c9c3f0428c2712178">data::rowDim</a>] * scale[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a9f473e3b41b1b75c9c3f0428c2712178">data::rowDim</a>],
<a name="l00830"></a>00830         mat_rows[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4d76e19bcda99794dc317e4dfacb2f3c">data::columnDim</a>] * scale[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4d76e19bcda99794dc317e4dfacb2f3c">data::columnDim</a>],
<a name="l00831"></a>00831         mat_rows[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a5ac8c76240726965f794dcedcb675d8e">data::sliceDim</a>] * scale[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a5ac8c76240726965f794dcedcb675d8e">data::sliceDim</a>],
<a name="l00832"></a>00832         offset
<a name="l00833"></a>00833     ).transpose();<span class="comment">// the columns of the transform matrix are the scaled row-, column-, sliceVec and the offset</span>
<a name="l00834"></a>00834     image2isis.elem( 3, 3 ) = 1; <span class="comment">// element 4/4 must be &quot;1&quot;</span>
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">return</span> nifti2isis.transpose().dot( image2isis ); <span class="comment">// apply inverse transform from nifti to isis =&gt; return transformation from image to nifti space</span>
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="keywordtype">void</span> ImageFormat_NiftiSa::useSForm( util::PropertyMap &amp;props )
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841     <span class="comment">// srow_? is the linear map from image space to nifti space (not isis space)</span>
<a name="l00842"></a>00842     <span class="comment">// [x] [ nifti/srow_x ]   [i]</span>
<a name="l00843"></a>00843     <span class="comment">// [y]=[ nifti/srow_y ] * [j]</span>
<a name="l00844"></a>00844     <span class="comment">// [z] [ nifti/srow_z ]   [k]</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Using sform (&quot;</span> &lt;&lt; props.propertyValue( <span class="stringliteral">&quot;nifti/sform_code&quot;</span> ).toString() &lt;&lt; <span class="stringliteral">&quot;) &quot;</span> &lt;&lt; util::MSubject(
<a name="l00847"></a>00847         props.propertyValue( <span class="stringliteral">&quot;nifti/srow_x&quot;</span> ).toString() + <span class="stringliteral">&quot;-&quot;</span> +
<a name="l00848"></a>00848         props.propertyValue( <span class="stringliteral">&quot;nifti/srow_y&quot;</span> ).toString() + <span class="stringliteral">&quot;-&quot;</span> +
<a name="l00849"></a>00849         props.propertyValue( <span class="stringliteral">&quot;nifti/srow_z&quot;</span> ).toString()
<a name="l00850"></a>00850     ) &lt;&lt; <span class="stringliteral">&quot; to calc orientation&quot;</span>;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="comment">// transform from image space to nifti space</span>
<a name="l00854"></a>00854     <span class="keyword">const</span> util::Matrix4x4&lt;float&gt; image2nifti(
<a name="l00855"></a>00855         props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_x&quot;</span> ),
<a name="l00856"></a>00856         props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_y&quot;</span> ),
<a name="l00857"></a>00857         props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/srow_z&quot;</span> )
<a name="l00858"></a>00858     );
<a name="l00859"></a>00859     util::Matrix4x4&lt;float&gt; image2isis = nifti2isis.dot( image2nifti ); <span class="comment">// add transform to isis-space</span>
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="comment">//get position of image-voxel 0,0,0,0 in isis space</span>
<a name="l00862"></a>00862     <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a> origin = image2isis.dot( <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 0, 0, 1 ) );
<a name="l00863"></a>00863     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span>, origin )-&gt;castTo&lt;util::fvector4&gt;()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] = 0; <span class="comment">// timedim is 1 from the matrix calc</span>
<a name="l00864"></a>00864     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Computed indexOrigin=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="comment">//remove offset from image2isis</span>
<a name="l00867"></a>00867     image2isis = util::Matrix4x4&lt;float&gt;(
<a name="l00868"></a>00868         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 1, 0, 0, -origin[0] ),
<a name="l00869"></a>00869         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 1, 0, -origin[1] ),
<a name="l00870"></a>00870         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 0, 1, -origin[2] )
<a name="l00871"></a>00871     ).dot( image2isis );
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="keyword">const</span> <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a> voxelSize( <span class="comment">// get voxel sizes by transforming othogonal vectors of one voxel from image to isis</span>
<a name="l00874"></a>00874         image2isis.dot( <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 1, 0, 0 ) ).len(),
<a name="l00875"></a>00875         image2isis.dot( <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 1, 0 ) ).len(),
<a name="l00876"></a>00876         image2isis.dot( <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 0, 1 ) ).len()
<a name="l00877"></a>00877     );
<a name="l00878"></a>00878     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span>, voxelSize )-&gt;castTo&lt;util::fvector4&gt;()[<a class="code" href="namespaceisis_1_1data.html#a157a8a81ce7fb08f84af9c27b7d251a3a4dbae8110b827f0716817c3ae5e44b55">data::timeDim</a>] = 0; <span class="comment">// timedim is 1 from the matrix calc</span>
<a name="l00879"></a>00879     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Computed voxelSize=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <span class="comment">//remove scaling from image2isis</span>
<a name="l00883"></a>00883     image2isis = image2isis.dot( util::Matrix4x4&lt;float&gt;(
<a name="l00884"></a>00884         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 1 / voxelSize[0], 0, 0 ),
<a name="l00885"></a>00885         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 1 / voxelSize[1], 0 ),
<a name="l00886"></a>00886         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 0, 0, 1 / voxelSize[2] )
<a name="l00887"></a>00887     ) );
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span>, image2isis.transpose().getRow( 0 ) );
<a name="l00890"></a>00890     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span>, image2isis.transpose().getRow( 1 ) );
<a name="l00891"></a>00891     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span>, image2isis.transpose().getRow( 2 ) );
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00894"></a>00894             &lt;&lt; <span class="stringliteral">&quot;Computed rowVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00895"></a>00895     &lt;&lt; <span class="stringliteral">&quot;columnVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; and &quot;</span>
<a name="l00896"></a>00896     &lt;&lt; <span class="stringliteral">&quot;sliceVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from sform&quot;</span>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     props.remove( <span class="stringliteral">&quot;nifti/srow_x&quot;</span> );
<a name="l00899"></a>00899     props.remove( <span class="stringliteral">&quot;nifti/srow_y&quot;</span> );
<a name="l00900"></a>00900     props.remove( <span class="stringliteral">&quot;nifti/srow_z&quot;</span> );
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 <span class="keywordtype">void</span> ImageFormat_NiftiSa::useQForm( util::PropertyMap &amp;props )
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="comment">// orientation //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00906"></a>00906     <span class="comment">//inspired by/stolen from nifticlib/nifti1_io.c:1466</span>
<a name="l00907"></a>00907     <span class="comment">//see http://nifti.nimh.nih.gov/nifti-1/documentation/nifti1fields/nifti1fields_pages/quatern.html</span>
<a name="l00908"></a>00908     <span class="comment">//and http://nifti.nimh.nih.gov/nifti-1/documentation/nifti1fields/nifti1fields_pages/qformExt.jpg</span>
<a name="l00909"></a>00909     <a class="code" href="namespaceisis_1_1util.html#a95fd2a2f3c43b5414665ac7640d45f85">util::dvector4</a> quaternion(
<a name="l00910"></a>00910         0,<span class="comment">//a</span>
<a name="l00911"></a>00911         props.getPropertyAs&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span> ),
<a name="l00912"></a>00912         props.getPropertyAs&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span> ),
<a name="l00913"></a>00913         props.getPropertyAs&lt;<span class="keywordtype">double</span>&gt;( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span> )
<a name="l00914"></a>00914     );
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     <span class="keywordtype">double</span> &amp;a = quaternion[0], &amp;b = quaternion[1], &amp;c = quaternion[2], &amp;d = quaternion[3];
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keywordflow">if</span>( 1 - quaternion.sqlen() &lt; 1.e-7 ) { <span class="comment">//if the quaternion is to &quot;long&quot;</span>
<a name="l00919"></a>00919         quaternion.norm();      <span class="comment">//normalize it and leave the angle as 0</span>
<a name="l00920"></a>00920     } <span class="keywordflow">else</span> {
<a name="l00921"></a>00921         a = sqrt( 1 - quaternion.sqlen() );                 <span class="comment">/* angle = 2*arccos(a) */</span>
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00925"></a>00925             &lt;&lt; <span class="stringliteral">&quot;Using qform (&quot;</span> &lt;&lt; props.propertyValue( <span class="stringliteral">&quot;nifti/qform_code&quot;</span> ).toString()
<a name="l00926"></a>00926     &lt;&lt; <span class="stringliteral">&quot;) quaternion=&quot;</span> &lt;&lt; <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( a, b, c, d ) &lt;&lt; <span class="stringliteral">&quot; with qfac=&quot;</span> &lt;&lt; props.propertyValue( <span class="stringliteral">&quot;nifti/qfac&quot;</span> ).toString()
<a name="l00927"></a>00927     &lt;&lt; <span class="stringliteral">&quot;, pixdim=&quot;</span> &lt;&lt; props.propertyValue( <span class="stringliteral">&quot;nifti/pixdim&quot;</span> ).toString()
<a name="l00928"></a>00928     &lt;&lt; <span class="stringliteral">&quot; and qoffset= &quot;</span> &lt;&lt; props.propertyValue( <span class="stringliteral">&quot;nifti/qoffset&quot;</span> ).toString();
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     <span class="keyword">const</span> util::Matrix4x4&lt;double&gt; M(
<a name="l00931"></a>00931         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( a * a + b * b - c * c - d * d, 2 * b * c - 2 * a * d, 2 * b * d + 2 * a * c ),
<a name="l00932"></a>00932         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 2 * b * c + 2 * a * d, a * a + c * c - b * b - d * d, 2 * c * d - 2 * a * b ),
<a name="l00933"></a>00933         <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>( 2 * b * d - 2 * a * c, 2 * c * d + 2 * a * b, a * a + d * d - c * c - b * b )
<a name="l00934"></a>00934     );
<a name="l00935"></a>00935     <span class="keyword">const</span> util::Matrix4x4&lt;double&gt; image2isis = nifti2isis.dot( M );
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span>, image2isis.transpose().getRow( 0 ) );
<a name="l00938"></a>00938     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span>, image2isis.transpose().getRow( 1 ) );
<a name="l00939"></a>00939     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span>, image2isis.transpose().getRow( 2 ) );
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> )
<a name="l00942"></a>00942             &lt;&lt; <span class="stringliteral">&quot;Computed rowVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;rowVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00943"></a>00943     &lt;&lt; <span class="stringliteral">&quot;columnVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;columnVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; and &quot;</span>
<a name="l00944"></a>00944     &lt;&lt; <span class="stringliteral">&quot;sliceVec=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;sliceVec&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     props.remove( <span class="stringliteral">&quot;nifti/quatern_b&quot;</span> );
<a name="l00947"></a>00947     props.remove( <span class="stringliteral">&quot;nifti/quatern_c&quot;</span> );
<a name="l00948"></a>00948     props.remove( <span class="stringliteral">&quot;nifti/quatern_d&quot;</span> );
<a name="l00949"></a>00949     props.remove( <span class="stringliteral">&quot;nifti/qfac&quot;</span> );
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="comment">// indexOrigin //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00952"></a>00952     props.setPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span>, nifti2isis.dot( props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/qoffset&quot;</span> ) ) );
<a name="l00953"></a>00953     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Computed indexOrigin=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;indexOrigin&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00954"></a>00954     props.remove( <span class="stringliteral">&quot;nifti/qoffset&quot;</span> );
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="comment">// voxelSize //////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00957"></a>00957     props.transform&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;nifti/pixdim&quot;</span>, <span class="stringliteral">&quot;voxelSize&quot;</span> );
<a name="l00958"></a>00958     <a class="code" href="log_8hpp.html#adf04aa30f03b88d867f551c7d349f738">LOG</a>( <a class="code" href="namespaceisis_1_1image__io.html#a79a319eba04b38c999695a820f5804ed">Debug</a>, <a class="code" href="group__util.html#ggafe55030315ca143f9be26fd278df9f82ad97a38c0fafe61d63fdb883c85d0067a">info</a> ) &lt;&lt; <span class="stringliteral">&quot;Computed voxelSize=&quot;</span> &lt;&lt; props.getPropertyAs&lt;<a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a>&gt;( <span class="stringliteral">&quot;voxelSize&quot;</span> ) &lt;&lt; <span class="stringliteral">&quot; from qform&quot;</span>;
<a name="l00959"></a>00959 }
<a name="l00960"></a>00960 <span class="keywordtype">bool</span> ImageFormat_NiftiSa::storeQForm( <span class="keyword">const</span> util::PropertyMap &amp;props, _internal::nifti_1_header *head )
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">// take values of the 3x3 matrix == analog to the nifti reference implementation</span>
<a name="l00964"></a>00964     <span class="keyword">const</span> <a class="code" href="classisis_1_1util_1_1Matrix4x4.html">isis::util::Matrix4x4&lt; double &gt;</a> nifti2image = getNiftiMatrix( props ).transpose(); <span class="comment">//use the inverse of image2nifti to extract direction vectors easier</span>
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <a class="code" href="namespaceisis_1_1util.html#a620d9422050c6984bbac79fd7429b468">util::fvector4</a> col[3];
<a name="l00967"></a>00967 
<a name="l00968"></a>00968     <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; 3; i++ ) {
<a name="l00969"></a>00969         col[i] = nifti2image.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#a6b993e9ccbf8c34263a306fd48ac072b">getRow</a>( i ); <span class="comment">//nth column in image2nifti</span>
<a name="l00970"></a>00970         head-&gt;pixdim[i + 1] = col[i].len(); <span class="comment">//store voxel size (don&#39;t use voxelSize, thats without voxelGap)</span>
<a name="l00971"></a>00971         col[i].norm(); <span class="comment">// normalize the columns</span>
<a name="l00972"></a>00972     }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974     <span class="comment">// compute the determinant to determine if the transformation is proper</span>
<a name="l00975"></a>00975     <span class="keyword">const</span> <span class="keywordtype">float</span> determinant =
<a name="l00976"></a>00976     col[0][0] * col[1][1] * col[2][2] - col[0][0] * col[1][2] * col[2][1] - col[0][1] * col[1][0] * col[2][2] +
<a name="l00977"></a>00977     col[0][1] * col[1][2] * col[2][0] + col[0][2] * col[1][0] * col[2][1] - col[0][2] * col[1][1] * col[2][0];
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordflow">if</span>( determinant &gt; 0 ) {
<a name="l00980"></a>00980         head-&gt;pixdim[0] = 1;
<a name="l00981"></a>00981     } <span class="keywordflow">else</span> { <span class="comment">// improper =&gt; flip 3rd column</span>
<a name="l00982"></a>00982         col[2][0] = -col[2][0] ;
<a name="l00983"></a>00983         col[2][1] = -col[2][1] ;
<a name="l00984"></a>00984         col[2][2] = -col[2][2] ;
<a name="l00985"></a>00985         head-&gt;pixdim[0] = -1;
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="keywordflow">if</span>( !head-&gt;qform_code )head-&gt;qform_code = 1; <span class="comment">// default to 1 if not set till now</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="comment">// the following was more or less stolen from the nifti reference implementation</span>
<a name="l00991"></a>00991     <span class="keyword">const</span> <span class="keywordtype">float</span> a_square = col[0][0] + col[1][1] + col[2][2] + 1;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="keywordflow">if</span>( a_square &gt; 0.5 ) { <span class="comment">// simple case</span>
<a name="l00994"></a>00994         <span class="keyword">const</span> <span class="keywordtype">float</span> a = 0.5  * sqrt( a_square );
<a name="l00995"></a>00995         head-&gt;quatern_b = 0.25 * ( col[1][2] - col[2][1] ) / a;
<a name="l00996"></a>00996         head-&gt;quatern_c = 0.25 * ( col[2][0] - col[0][2] ) / a;
<a name="l00997"></a>00997         head-&gt;quatern_d = 0.25 * ( col[0][1] - col[1][0] ) / a;
<a name="l00998"></a>00998     } <span class="keywordflow">else</span> {                       <span class="comment">// trickier case</span>
<a name="l00999"></a>00999         <span class="keywordtype">float</span> xd = 1.0 + col[0][0] - ( col[1][1] + col[2][2] ) ; <span class="comment">/* 4*b*b */</span>
<a name="l01000"></a>01000         <span class="keywordtype">float</span> yd = 1.0 + col[1][1] - ( col[0][0] + col[2][2] ) ; <span class="comment">/* 4*c*c */</span>
<a name="l01001"></a>01001         <span class="keywordtype">float</span> zd = 1.0 + col[2][2] - ( col[0][0] + col[1][1] ) ; <span class="comment">/* 4*d*d */</span>
<a name="l01002"></a>01002         <span class="keywordtype">float</span> a;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         <span class="keywordflow">if</span>( xd &gt; 1.0 ) {
<a name="l01005"></a>01005             head-&gt;quatern_b = 0.5l * sqrt( xd ) ;
<a name="l01006"></a>01006             head-&gt;quatern_c = 0.25l * ( col[1][0] + col[0][1] ) / head-&gt;quatern_b ;
<a name="l01007"></a>01007             head-&gt;quatern_d = 0.25l * ( col[2][0] + col[0][2] ) / head-&gt;quatern_b ;
<a name="l01008"></a>01008             a = 0.25l * ( col[1][2] - col[2][1] ) / head-&gt;quatern_b ;
<a name="l01009"></a>01009         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( yd &gt; 1.0 ) {
<a name="l01010"></a>01010             head-&gt;quatern_c = 0.5l * sqrt( yd ) ;
<a name="l01011"></a>01011             head-&gt;quatern_b = 0.25l * ( col[1][0] + col[0][1] ) / head-&gt;quatern_c ;
<a name="l01012"></a>01012             head-&gt;quatern_d = 0.25l * ( col[2][1] + col[1][2] ) / head-&gt;quatern_c ;
<a name="l01013"></a>01013             a = 0.25l * ( col[2][0] - col[0][2] ) / head-&gt;quatern_c ;
<a name="l01014"></a>01014         } <span class="keywordflow">else</span> {
<a name="l01015"></a>01015             head-&gt;quatern_d = 0.5l * sqrt( zd ) ;
<a name="l01016"></a>01016             head-&gt;quatern_b = 0.25l * ( col[2][0] + col[0][2] ) / head-&gt;quatern_d ;
<a name="l01017"></a>01017             head-&gt;quatern_c = 0.25l * ( col[2][1] + col[1][2] ) / head-&gt;quatern_d ;
<a name="l01018"></a>01018             a = 0.25 * ( col[0][1] - col[1][0] ) / head-&gt;quatern_d ;
<a name="l01019"></a>01019         }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         <span class="keywordflow">if</span>( a &lt; 0.0 ) {
<a name="l01022"></a>01022             head-&gt;quatern_b = -head-&gt;quatern_b ;
<a name="l01023"></a>01023             head-&gt;quatern_c = -head-&gt;quatern_c ;
<a name="l01024"></a>01024             head-&gt;quatern_d = -head-&gt;quatern_d;
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     head-&gt;qoffset_x = nifti2image.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#a600324601e68d2238acebe25a3ae7c63">elem</a>( 0, 3 );
<a name="l01029"></a>01029     head-&gt;qoffset_y = nifti2image.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#a600324601e68d2238acebe25a3ae7c63">elem</a>( 1, 3 );
<a name="l01030"></a>01030     head-&gt;qoffset_z = nifti2image.<a class="code" href="classisis_1_1util_1_1FixedMatrix.html#a600324601e68d2238acebe25a3ae7c63">elem</a>( 2, 3 );
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 <span class="keywordtype">void</span> ImageFormat_NiftiSa::storeSForm( <span class="keyword">const</span> util::PropertyMap &amp;props, _internal::nifti_1_header *head )
<a name="l01035"></a>01035 {
<a name="l01036"></a>01036     <span class="keyword">const</span> util::Matrix4x4&lt;double&gt; sform = getNiftiMatrix( props );
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="keywordflow">if</span>( !head-&gt;sform_code )head-&gt;sform_code = 1; <span class="comment">// default to 1 if not set till now</span>
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     sform.getRow( 0 ).copyTo( head-&gt;srow_x );
<a name="l01041"></a>01041     sform.getRow( 1 ).copyTo( head-&gt;srow_y );
<a name="l01042"></a>01042     sform.getRow( 2 ).copyTo( head-&gt;srow_z );
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 <span class="comment">// The nifti coord system:</span>
<a name="l01046"></a>01046 <span class="comment">// The (x,y,z) coordinates refer to the CENTER of a voxel.</span>
<a name="l01047"></a>01047 <span class="comment">// In methods 2 and 3, the (x,y,z) axes refer to a subject-based coordinate system, with +x = Right  +y = Anterior  +z = Superior.</span>
<a name="l01048"></a>01048 <span class="comment">// So, the transform from nifti to isis is:</span>
<a name="l01049"></a>01049 <span class="keyword">const</span> util::Matrix4x4&lt;short&gt; ImageFormat_NiftiSa::nifti2isis(
<a name="l01050"></a>01050     util::vector4&lt;short&gt;( -1, 0, 0, 0 ),
<a name="l01051"></a>01051     util::vector4&lt;short&gt;( 0, -1, 0, 0 ),
<a name="l01052"></a>01052     util::vector4&lt;short&gt;( 0, 0, 1, 0 ),
<a name="l01053"></a>01053     util::vector4&lt;short&gt;( 0, 0, 0, 1 )
<a name="l01054"></a>01054 );
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 <span class="comment">// define form codes</span>
<a name="l01057"></a>01057 <span class="comment">// UNKNOWN=0      this is implizit as undef</span>
<a name="l01058"></a>01058 <span class="comment">// SCANNER_ANAT=1 scanner-based anatomical coordinates</span>
<a name="l01059"></a>01059 <span class="comment">// ALIGNED_ANAT=2 coordinates aligned to another file&#39;s, or to anatomical &quot;truth&quot;.</span>
<a name="l01060"></a>01060 <span class="comment">// TALAIRACH    3 coordinates aligned to Talairach-Tournoux Atlas; (0,0,0)=AC, etc</span>
<a name="l01061"></a>01061 <span class="comment">// MNI_152      4 MNI 152 normalized coordinates</span>
<a name="l01062"></a>01062 <span class="keyword">const</span> util::Selection ImageFormat_NiftiSa::formCode( <span class="stringliteral">&quot;SCANNER_ANAT,ALIGNED_ANAT,TALAIRACH,MNI_152&quot;</span> );
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 }
<a name="l01065"></a>01065 }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067 
<a name="l01068"></a><a class="code" href="imageFormat__nifti__sa_8cpp.html#aa8b483f374fb36a1a13eccaa9e5e70ab">01068</a> <a class="code" href="classisis_1_1image__io_1_1FileFormat.html" title="Base class for image-io-plugins.">isis::image_io::FileFormat</a> *<a class="code" href="io__interface_8h.html#aa8b483f374fb36a1a13eccaa9e5e70ab">factory</a>()
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classisis_1_1image__io_1_1ImageFormat__NiftiSa.html">isis::image_io::ImageFormat_NiftiSa</a>();
<a name="l01071"></a>01071 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Feb 21 2012 18:30:59 for ISIS Core Library by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
